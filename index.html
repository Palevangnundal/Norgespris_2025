<!doctype html>
<html lang="nb">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Norgespris – beregning og graf</title>
  <meta name="description" content="Sammenlign Norgespris med spotpris med strømstøtte. Legg inn årlig forbruk eller egne månedstall og se kostnad.">
  <style>
    :root{ --bg:#f7f7f8; --fg:#111; --muted:#6b7280; --card:#fff; --border:#e5e7eb; --brand:#111827; }
    *{ box-sizing:border-box }
    html,body{ margin:0; background:var(--bg); color:var(--fg); font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; }
    .wrap{ max-width:1200px; margin:0 auto; padding:16px; }
    h1{ font-size:22px; margin:0 0 6px }
    p{ margin:0 0 12px; color:var(--muted) }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; }
    .grid{ display:grid; gap:12px }
    .g2{ grid-template-columns:repeat(2,minmax(0,1fr)) }
    .g3{ grid-template-columns:repeat(3,minmax(0,1fr)) }
    @media (max-width:1000px){ .g2,.g3{ grid-template-columns:1fr } }
    label{ display:block; font-size:13px; color:var(--muted); margin-bottom:6px }
    input[type="number"], select, button{ font:inherit }
    input[type="number"], select{ width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:#fff }
    input[type="range"]{ width:100% }
    button{ padding:8px 12px; border-radius:10px; border:1px solid var(--border); background:#fff; cursor:pointer }
    .row{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
    .pill{ display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; font-size:13px }
    .muted{ color:var(--muted) }
    .big{ font-size:20px; font-weight:700 }
    .kv{ font-variant-numeric: tabular-nums }
    .legend{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; font-size:13px; color:var(--muted) }
    .dot{ width:10px; height:10px; border-radius:50% }
    .hr{ height:1px; background:var(--border); border:0; margin:8px 0 }
    table{ width:100%; border-collapse:collapse; font-variant-numeric:tabular-nums }
    th,td{ padding:8px 10px; border-bottom:1px solid var(--border); text-align:right }
    th:first-child, td:first-child{ text-align:left }
    tfoot td{ font-weight:700 }
    .chips{ display:flex; gap:8px; flex-wrap:wrap }
    .chip{ padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; cursor:pointer; }
    .chip.active{ background:#111827; color:#fff; border-color:#111827 }
    .note{ background:#fffaf0; border:1px solid #fde68a; color:#92400e; padding:10px 12px; border-radius:12px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="wrap">
  <h1>Norgespris – beregning og graf</h1>
  <p>Legg inn årlig forbruk eller egne månedstall. Vi bruker <b>månedssnitt</b> fra <code>data/monthly_avgs_v1.csv</code> for valgt prisområde og sammenligner <b>Norgespris</b> med <b>spotpris med strømstøtte</b>. Alle beløp vises <b>inkl. mva</b>.</p>

  <!-- Inndata -->
  <div class="card grid g3" style="margin-top:8px">
    <div>
      <label for="area">Prisområde</label>
      <select id="area"></select>
      <small class="muted">NO1 – Oslo/Østlandet er standard hvis tilgjengelig.</small>
    </div>

    <div>
      <label for="annual">Årlig forbruk (kWh)</label>
      <input id="annual" type="number" value="20000" min="0" step="100">
      <small class="muted">Bruk helår. Vi fordeler på måneder (kan overstyres manuelt).</small>
    </div>

    <div>
      <label for="shape">Vinter/sommer-justering</label>
      <input id="shape" type="range" min="-50" max="50" value="0">
      <div class="row">
        <span class="muted">Vintertung</span>
        <span id="shapeOut" class="pill">0%</span>
        <span class="muted">Flatere</span>
      </div>
      <small class="muted">–50% = flatere, +50% = mer vintertungt.</small>
    </div>

    <div>
      <label>Elbil</label>
      <div class="row">
        <input id="ev" type="checkbox">
        <span>Lader elbil hjemme</span>
      </div>
      <div class="row" style="margin-top:6px">
        <label for="evkm" style="margin:0;min-width:150px">Km per år</label>
        <input id="evkm" type="number" value="12000" min="0" step="500" disabled>
        <span class="pill">0,2 kWh/km</span>
      </div>
      <small class="muted">Elbilforbruk fordeles jevnt over året og flater profilen.</small>
    </div>

    <div>
      <label>Forbruksperiode</label>
      <div id="periodChips" class="chips"></div>
      <small class="muted">Velg “Siste 12 mnd” eller et bestemt år.</small>
    </div>

    <div>
      <label>Legg inn eget forbruk per måned</label>
      <div class="row">
        <input id="customToggle" type="checkbox">
        <span>Overstyr estimert månedsfordeling</span>
      </div>
      <small class="muted">Når aktivert blir feltene under redigerbare. Du kan fylle inn selv eller hente estimert profil.</small>
    </div>
  </div>

  <div class="note" style="margin-top:10px">
    <b>Viktig:</b> Nettleie og statlige avgifter er <b>ikke</b> inkludert – de er i praksis like uansett om du har spot/strømstøtte eller Norgespris.
  </div>

  <!-- Oppsummering -->
  <div class="card grid g3" style="margin-top:12px">
    <div>
      <div class="big kv" style="margin-bottom:4px">Estimert strømkostnad (inkl. mva)</div>
      <div class="muted">for valgt periode</div>
    </div>
    <div>
      <div class="muted">Norgespris</div>
      <div class="big kv" id="sumN">–</div>
    </div>
    <div>
      <div class="muted">Spot m/strømstøtte</div>
      <div class="big kv" id="sumS">–</div>
    </div>
  </div>

  <!-- Stolpediagram + redigerbare måneder -->
  <div class="card" style="margin-top:12px">
    <div class="row" style="justify-content:space-between">
      <div class="muted">Forbruk og kostnad per måned (valgt periode)</div>
      <div id="status" class="muted">Laster data …</div>
    </div>
    <div class="hr"></div>
    <div style="height:360px"><canvas id="barChart"></canvas></div>

    <div class="hr"></div>

    <div id="customInputs" class="grid g3" style="display:none; margin-bottom:8px"></div>
    <div class="row" id="customButtons" style="display:none; margin-bottom:8px">
      <button id="fillProfile">Fyll med estimert profil</button>
      <button id="clearAll">Tøm alle</button>
    </div>

    <div style="overflow:auto">
      <table id="tbl">
        <thead>
          <tr>
            <th>Måned</th>
            <th>kWh</th>
            <th>kr/kWh spot</th>
            <th>kr/kWh Norgespris</th>
            <th>Kr spot</th>
            <th>Kr Norgespris</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td>SUM</td>
            <td id="sumKwh">–</td>
            <td></td><td></td>
            <td id="sumCostS">–</td>
            <td id="sumCostN">–</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <p><b>Om månedssnitt med strømstøtte:</b> Månedssnittet vi viser for “spotpris med strømstøtte” er beregnet med støtte
      <i>kun for de timene i måneden hvor spotprisen er over terskelen for strømstøtte</i>.
      Derfor kan vårt månedssnitt avvike fra gjennomsnittstall hos Nord Pool eller andre kilder.</p>
  </div>

  <!-- Prisgraf (hele serien) -->
  <div class="card" style="margin-top:12px">
    <div class="row" style="justify-content:space-between">
      <div class="muted">Månedspriser (inkl. mva) – hele dataserien</div>
      <div class="legend">
        <span class="dot" style="background:#2563eb"></span> Spot m/strømstøtte
        <span class="dot" style="background:#16a34a"></span> Norgespris (blandet effektiv pris)
      </div>
    </div>
    <div class="hr"></div>
    <div style="height:300px"><canvas id="priceChart"></canvas></div>
  </div>
</div>

<script>
  // ---- Konstanter & hjelpere ----
  const VAT = 0.25;
  const NORGESPRIS_EX_ORE = 40;     // eks. mva (øre/kWh)
  const CAP_KWH = 4000;             // tak per måned
  const EV_KWH_PER_KM = 0.2;        // kWh/km
  const MONTHS = ["Jan","Feb","Mar","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Des"];
  const AREA_INFO = {
    NO1: "NO1 – Oslo / Østlandet",
    NO2: "NO2 – Kristiansand / Sørlandet",
    NO3: "NO3 – Trondheim / Midt-Norge",
    NO4: "NO4 – Tromsø / Nord-Norge",
    NO5: "NO5 – Bergen / Vestlandet",
    NO6: "NO6 – Nord-øst (hvis tilgjengelig)"
  };

  // Basisprofil: Jan høyest → Jul lavest. Normaliseres til 100 %.
  const BASE_PROFILE = [13.5,12,10,8.5,7,5.5,4.5,5,7,8.5,10,12];
  const normalizeProfile = p => {
    const s = p.reduce((a,b)=>a+b,0);
    return p.map(x => x * 100 / s);
  };
  // shape ∈ [-0.5, +0.5] → -0.5 flater ut, +0.5 mer vintertung
  function shapedProfile(shape){
    const base = normalizeProfile(BASE_PROFILE);
    const uniform = 100/12;
    return base.map(p => uniform + (p - uniform) * (1 + shape));
  }

  function annualToMonthly(annual, shape, evOn, evKm){
    const prof = shapedProfile(shape);
    const evAnnual = evOn ? (evKm * EV_KWH_PER_KM) : 0;
    const baseAnnual = Math.max(0, annual - evAnnual);
    const perMonthEv = evAnnual / 12;
    return prof.map(pct => baseAnnual * (pct/100) + perMonthEv);
  }

  const kroner = n => (n||0).toLocaleString("nb-NO",{ style:"currency", currency:"NOK", maximumFractionDigits:0 });
  const fixedIncl = () => (NORGESPRIS_EX_ORE/100) * (1+VAT);
  const q = (arr,p=0.95) => {
    const a = arr.filter(Number.isFinite).slice().sort((x,y)=>x-y);
    if(!a.length) return 1; const i = Math.floor((a.length-1)*p); return a[i];
  };

  // ---- Robust CSV-las ting: BOM + separator + desimal-komma ----
  async function loadMonthlyAvgs(){
    const res = await fetch('data/monthly_avgs_v1.csv', { cache: 'no-store' });
    if(!res.ok) throw new Error('Kunne ikke hente data/monthly_avgs_v1.csv');

    // 1) Normaliser tekst og fjern BOM/CRLF
    let txt = await res.text();
    txt = txt.replace(/^\uFEFF/, '').replace(/\r\n?/g, '\n').trim();
    if (!txt) throw new Error('CSV er tom');

    // 2) Finn separator automatisk
    const firstLine = txt.split('\n', 1)[0];
    const seps = [',',';','\t','|'];
    const sep = seps.reduce((best, s) => {
      const count = (firstLine.match(new RegExp(`\\${s}`,'g'))||[]).length;
      return count > best.count ? { s, count } : best;
