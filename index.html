<!doctype html>
<html lang="nb">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Norgespris – beregning og graf</title>
  <meta name="description" content="Sammenlign Norgespris med spotpris med strømstøtte. Legg inn årlig forbruk eller egne månedstall og se kostnad.">
  <style>
    :root{ --bg:#f7f7f8; --fg:#111; --muted:#6b7280; --card:#fff; --border:#e5e7eb; --brand:#111827; }
    *{ box-sizing:border-box }
    html,body{ margin:0; background:var(--bg); color:var(--fg); font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; }
    .wrap{ max-width:1200px; margin:0 auto; padding:16px; }
    h1{ font-size:22px; margin:0 0 6px }
    p{ margin:0 0 12px; color:var(--muted) }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; }
    .grid{ display:grid; gap:12px }
    .g2{ grid-template-columns:repeat(2,minmax(0,1fr)) }
    .g3{ grid-template-columns:repeat(3,minmax(0,1fr)) }
    @media (max-width:1000px){ .g2,.g3{ grid-template-columns:1fr } }
    label{ display:block; font-size:13px; color:var(--muted); margin-bottom:6px }
    input[type="number"], select, button{ font:inherit }
    input[type="number"], select{ width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:#fff }
    input[type="range"]{ width:100% }
    button{ padding:8px 12px; border-radius:10px; border:1px solid var(--border); background:#fff; cursor:pointer }
    .row{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
    .pill{ display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; font-size:13px }
    .muted{ color:var(--muted) }
    .big{ font-size:20px; font-weight:700 }
    .kv{ font-variant-numeric: tabular-nums }
    .legend{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; font-size:13px; color:var(--muted) }
    .dot{ width:10px; height:10px; border-radius:50% }
    .hr{ height:1px; background:var(--border); border:0; margin:8px 0 }
    table{ width:100%; border-collapse:collapse; font-variant-numeric:tabular-nums }
    th,td{ padding:8px 10px; border-bottom:1px solid var(--border); text-align:right }
    th:first-child, td:first-child{ text-align:left }
    tfoot td{ font-weight:700 }
    .chips{ display:flex; gap:8px; flex-wrap:wrap }
    .chip{ padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; cursor:pointer; }
    .chip.active{ background:#111827; color:#fff; border-color:#111827 }
    .note{ background:#fffaf0; border:1px solid #fde68a; color:#92400e; padding:10px 12px; border-radius:12px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="wrap">
  <h1>Norgespris – beregning og graf</h1>
  <p>Legg inn årlig forbruk eller egne månedstall. Vi bruker <b>månedssnitt</b> fra <code>data/monthly_avgs_v1.csv</code> for valgt prisområde og sammenligner <b>Norgespris</b> med <b>spotpris med strømstøtte</b>. Alle beløp vises <b>inkl. mva</b>.</p>

  <!-- Inndata -->
  <div class="card grid g3" style="margin-top:8px">
    <div>
      <label for="area">Prisområde</label>
      <select id="area"></select>
      <small class="muted">NO1 – Oslo/Østlandet er standard hvis tilgjengelig.</small>
    </div>

    <div>
      <label for="annual">Årlig forbruk (kWh)</label>
      <input id="annual" type="number" value="20000" min="0" step="100">
      <small class="muted">Bruk helår. Vi fordeler på måneder (kan overstyres manuelt).</small>
    </div>

    <div>
      <label>Isoleringsgrad</label>
      <div id="insulChips" class="chips"></div>
      <label for="shape" style="margin-top:6px">Vinter/sommer-justering</label>
      <input id="shape" type="range" min="-50" max="50" value="0">
      <div class="row">
        <span class="muted">Vintertung</span>
        <span id="shapeOut" class="pill">0%</span>
        <span class="muted">Flatere</span>
      </div>
      <small class="muted">Velg en isoleringsgrad og finjustér med slider (–50% = flatere, +50% = mer vintertung).</small>
    </div>

    <div>
      <label>Brukstype</label>
      <div id="useChips" class="chips"></div>
      <small class="muted">Velg <b>Bolig</b> (standard vintertung) eller <b>Fritidsbolig</b> (sommerprofil).</small>
    </div>

    <div>
      <label>Elbil</label>
      <div class="row">
        <input id="ev" type="checkbox">
        <span>Lader elbil hjemme</span>
      </div>
      <div class="row" style="margin-top:6px">
        <label for="evkm" style="margin:0;min-width:150px">Km per år</label>
        <input id="evkm" type="number" value="12000" min="0" step="500" disabled>
        <span class="pill">0,2 kWh/km</span>
      </div>
      <small class="muted">Elbilforbruk fordeles jevnt over året og flater profilen.</small>
    </div>

    <div>
      <label>Forbruksperiode</label>
      <div id="periodChips" class="chips"></div>
      <small class="muted">Velg “Siste 12 mnd” eller et bestemt år.</small>
    </div>

    <div>
      <label>Legg inn eget forbruk per måned</label>
      <div class="row">
        <input id="customToggle" type="checkbox">
        <span>Aktiver manuell utfylling</span>
      </div>
      <small class="muted">Når aktivert blir feltene under redigerbare. Du kan fylle inn selv eller hente estimert profil.</small>
    </div>
  </div>

  <div class="note" style="margin-top:10px">
    <b>Viktig:</b> Nettleie og statlige avgifter er <b>ikke</b> inkludert – de er i praksis like uansett om du har spot/strømstøtte eller Norgespris.
  </div>

  <!-- Oppsummering -->
  <div class="card grid g3" style="margin-top:12px">
    <div>
      <div class="big kv" style="margin-bottom:4px">Estimert strømkostnad (inkl. mva)</div>
      <div class="muted">for valgt periode</div>
    </div>
    <div>
      <div class="muted">Norgespris</div>
      <div class="big kv" id="sumN">–</div>
      <div class="muted" id="besparelseText" style="margin-top:6px"></div>
    </div>
    <div>
      <div class="muted">Spot m/strømstøtte</div>
      <div class="big kv" id="sumS">–</div>
      <div class="muted"><b>Besparelse Norgespris:</b> <span id="saveOut">–</span></div>
    </div>
  </div>

  <!-- Stolpediagram + redigerbare måneder -->
  <div class="card" style="margin-top:12px">
    <div class="row" style="justify-content:space-between">
      <div class="muted">Forbruk og kostnad per måned (valgt periode)</div>
      <div id="status" class="muted">Laster data …</div>
    </div>
    <div class="hr"></div>
    <div style="height:360px"><canvas id="barChart"></canvas></div>

    <div class="hr"></div>

    <div id="customInputs" class="grid g3" style="display:none; margin-bottom:8px"></div>
    <div class="row" id="customButtons" style="display:none; margin-bottom:8px">
      <button id="fillProfile">Fyll med estimert profil</button>
      <button id="clearAll">Tøm alle</button>
    </div>

    <div style="overflow:auto">
      <table id="tbl">
        <thead>
          <tr>
            <th>Måned</th>
            <th>kWh</th>
            <th id="thPS">kr/kWh m. strømstøtte</th>
            <th id="thPNo">kr/kWh u. strømstøtte</th>
            <th>kr/kWh Norgespris</th>
            <th>Kr spot</th>
            <th>Kr Norgespris</th>
            <th>Besparelse (Norgespris–Spot)</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td>SUM</td>
            <td id="sumKwh">–</td>
            <td></td><td></td><td></td>
            <td id="sumCostS">–</td>
            <td id="sumCostN">–</td>
            <td id="sumDelta">–</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <p><b>Om månedssnitt med strømstøtte:</b> Månedssnittet vi viser for “spotpris med strømstøtte” er beregnet med støtte
      <i>kun for de timene i måneden hvor spotprisen er over terskelen for strømstøtte</i>.
      Derfor kan vårt månedssnitt avvike fra gjennomsnittstall hos Nord Pool eller andre kilder.</p>
  </div>

  <!-- Prisgraf (hele serien) -->
  <div class="card" style="margin-top:12px">
    <div class="row" style="justify-content:space-between">
      <div class="muted">Månedspriser (inkl. mva) – hele dataserien</div>
      <div class="legend">
        <span class="dot" style="background:#2563eb"></span> Spot m/strømstøtte
        <span class="dot" style="background:#16a34a"></span> Norgespris (blandet effektiv pris)
      </div>
    </div>
    <div class="hr"></div>
    <div style="height:300px"><canvas id="priceChart"></canvas></div>
  </div>
</div>

<script>
  // ---- Konstanter & hjelpere ----
  const VAT = 0.25;
  const NORGESPRIS_EX_ORE = 40;     // eks. mva (øre/kWh)
  const CAP_KWH = 4000;             // tak per måned
  const EV_KWH_PER_KM = 0.2;        // kWh/km
  const MONTHS = ["Jan","Feb","Mar","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Des"];
  const AREA_INFO = {
    NO1: "NO1 – Oslo / Østlandet",
    NO2: "NO2 – Kristiansand / Sørlandet",
    NO3: "NO3 – Trondheim / Midt-Norge",
    NO4: "NO4 – Tromsø / Nord-Norge",
    NO5: "NO5 – Bergen / Vestlandet",
    NO6: "NO6 – Nord-øst (hvis tilgjengelig)"
  };

  // Basisprofil (vintertung) og sommerprofil (fritidsbolig). Begge normaliseres til 100 %.
  const BASE_WINTER = [13.5,12,10,8.5,7,5.5,4.5,5,7,8.5,10,12]; // Jan høyest
  const BASE_SUMMER = [6,6.5,7.5,8.5,9.5,10.5,11,10.5,9.5,8,6.5,5.5]; // Jun–Aug høyest

  const normalizeProfile = p => {
    const s = p.reduce((a,b)=>a+b,0)||1;
    return p.map(x => x * 100 / s);
  };

  // shape ∈ [-0.5, +0.5] → -0.5 flater ut, +0.5 forsterker valgt basis (vinter eller sommer)
  function shapedProfile(shape, useMode){
    const base = normalizeProfile(useMode === 'fritid' ? BASE_SUMMER : BASE_WINTER);
    const uniform = 100/12;
    return base.map(p => uniform + (p - uniform) * (1 + shape));
  }

  function annualToMonthly(annual, shape, evOn, evKm, useMode){
    const prof = shapedProfile(shape, useMode);
    const evAnnual = evOn ? (evKm * EV_KWH_PER_KM) : 0;
    const baseAnnual = Math.max(0, annual - evAnnual);
    const perMonthEv = evAnnual / 12;
    return prof.map(pct => baseAnnual * (pct/100) + perMonthEv);
  }

  const kroner = n => (n||0).toLocaleString("nb-NO",{ style:"currency", currency:"NOK", maximumFractionDigits:0 });
  const fixedIncl = () => (NORGESPRIS_EX_ORE/100) * (1+VAT);
  const q = (arr,p=0.95) => {
    const a = arr.filter(Number.isFinite).slice().sort((x,y)=>x-y);
    if(!a.length) return 1; const i = Math.floor((a.length-1)*p); return a[i];
  };

  // ---- Robust CSV: BOM + separator + desimal-komma ----
  async function loadMonthlyAvgs(){
    const res = await fetch('data/monthly_avgs_v1.csv', { cache: 'no-store' });
    if(!res.ok) throw new Error('Kunne ikke hente data/monthly_avgs_v1.csv');

    let txt = await res.text();
    txt = txt.replace(/^\uFEFF/, '').replace(/\r\n?/g, '\n').trim();
    if (!txt) throw new Error('CSV er tom');

    const firstLine = txt.split('\n', 1)[0];
    const seps = [',',';','\t','|'];
    const sep = seps.reduce((best, s) => {
      const count = (firstLine.match(new RegExp(`\\${s}`,'g'))||[]).length;
      return count > best.count ? { s, count } : best;
    }, { s: ',', count: 0 }).s;

    const [head, ...lines] = txt.split('\n').filter(l => l.trim().length);
    const headers = head.split(sep).map(h => h.replace(/^\uFEFF/,'').trim().toLowerCase());
    const idx = Object.fromEntries(headers.map((h,i)=>[h,i]));

    const need = ['area','year','month','avg_effective_nok_ex'];
    const missing = need.filter(k => !(k in idx));
    if (missing.length) throw new Error('Mangler kolonner i CSV: ' + missing.join(', '));

    const hasSpot = 'avg_spot_nok_ex' in idx;

    const sampleCols = (lines[0] || '').split(sep).map(s=>s.trim());
    const probe = [idx['avg_effective_nok_ex'], hasSpot ? idx['avg_spot_nok_ex'] : -1]
                    .map(i => i>=0 ? sampleCols[i] || '' : '');
    const usesCommaDecimal = probe.some(v => /,\d{1,3}$/.test(v) || (v.includes(',') && !v.includes('.')));

    const toNum = (s) => {
      if (s == null) return NaN;
      let t = String(s).trim();
      t = t.replace(/\u00A0/g,'').replace(/\s/g,''); // fjern NBSP og mellomrom
      if (usesCommaDecimal) t = t.replace(/\./g,'').replace(',', '.');
      return Number(t);
    };

    const rows = [];
    for (const line of lines) {
      const cols = line.split(sep);
      if (cols.length < headers.length) continue;
      const area = (cols[idx.area] || '').trim().toUpperCase();
      const year = toNum(cols[idx.year]);
      const month = toNum(cols[idx.month]);
      const eff_ex = toNum(cols[idx['avg_effective_nok_ex']]); // NOK/kWh eks mva (m/støtte)
      const spot_ex = hasSpot ? toNum(cols[idx['avg_spot_nok_ex']]) : NaN; // NOK/kWh eks mva (u/støtte)
      if (!area || !Number.isFinite(year) || !Number.isFinite(month)) continue;
      rows.push({ area, year, month, eff_ex, spot_ex });
    }

    const byAreaYear = {};
    const areas = new Set();
    const years = new Set();
    for (const r of rows) {
      areas.add(r.area);
      years.add(r.year);
      byAreaYear[r.area] ??= {};
      byAreaYear[r.area][r.year] ??= {};
      byAreaYear[r.area][r.year][r.month] = r;
    }

    return {
      byAreaYear,
      years: [...years].sort((a,b)=>a-b),
      areas: [...areas].sort()
    };
  }

  // ---- Periodevalg -> liste av måneder ----
  function monthsInPeriod(byAreaYear, area, period){ // returns [{y,m,row}]
    const ent = byAreaYear[area]||{};
    const years = Object.keys(ent).map(Number).sort((a,b)=>a-b);
    const list = [];
    for(const y of years){
      for(let m=1;m<=12;m++){
        const row = ent[y]?.[m];
        if(row) list.push({y, m, row});
      }
    }
    if(period === 'last12'){
      return list.slice(-12);
    } else {
      const y = Number(period);
      return (new Array(12)).fill(0).map((_,i)=>{
        const m = i+1; const row = ent[y]?.[m]; return row ? {y, m, row} : null;
      }).filter(Boolean);
    }
  }

  // ---- Beregning ----
  function compute(area, period, byAreaYear, monthlyKWh){
    const fixedEx = NORGESPRIS_EX_ORE/100;
    const ms = monthsInPeriod(byAreaYear, area, period);
    const labels = [], kwhArr = [], priceS = [], priceNo = [], priceN = [],
          costS = [], costN = [], table = [], delta = [];

    for(const {y,m,row} of ms){
      const kwh = monthlyKWh[m-1] || 0;

      // Spot m/støtte (eff_ex) og u/støtte (spot_ex) -> inkl. mva
      const priceEffIncl = row.eff_ex * (1+VAT);
      const priceNoIncl  = (Number.isFinite(row.spot_ex) ? row.spot_ex : row.eff_ex) * (1+VAT);

      // Norgespris: dekket opp til CAP til fastpris, overskytende til spot u/støtte
      const covered = Math.min(kwh, CAP_KWH);
      const excess  = Math.max(0, kwh - CAP_KWH);
      const spotExEx = Number.isFinite(row.spot_ex) ? row.spot_ex : row.eff_ex; // eks mva
      const priceNorgIncl = (kwh>0)
        ? ((covered*fixedEx + excess*spotExEx)*(1+VAT) / kwh)
        : fixedIncl();

      const cS = kwh * priceEffIncl;
      const cN = kwh * priceNorgIncl;

      labels.push(`${y}-${String(m).padStart(2,'0')}`);
      kwhArr.push(kwh);
      priceS.push(priceEffIncl);
      priceNo.push(priceNoIncl);
      priceN.push(priceNorgIncl);
      costS.push(cS);
      costN.push(cN);
      delta.push(cN - cS); // + = dyrere med Norgespris, - = besparelse

      table.push({
        month: `${MONTHS[m-1]} ${y}`,
        kwh, pS: priceEffIncl, pNo: priceNoIncl, pN: priceNorgIncl, cS, cN, d: cN - cS
      });
    }

    const sums = {
      kwh: kwhArr.reduce((a,b)=>a+b,0),
      cS: costS.reduce((a,b)=>a+b,0),
      cN: costN.reduce((a,b)=>a+b,0),
      d:  delta.reduce((a,b)=>a+b,0)
    };
    return { labels, kwhArr, priceS, priceNo, priceN, costS, costN, table, sums };
  }

  // ---- UI refs ----
  const areaEl = document.getElementById('area');
  const annualEl = document.getElementById('annual');
  const shapeEl = document.getElementById('shape'); const shapeOut = document.getElementById('shapeOut');
  const insulChips = document.getElementById('insulChips');
  const useChips = document.getElementById('useChips');
  const evEl = document.getElementById('ev'); const evKmEl = document.getElementById('evkm');
  const periodChips = document.getElementById('periodChips');

  const sumNEl = document.getElementById('sumN');
  const sumSEl = document.getElementById('sumS');
  const saveOutEl = document.getElementById('saveOut');
  const besparelseTextEl = document.getElementById('besparelseText');
  const statusEl = document.getElementById('status');

  const customToggle = document.getElementById('customToggle');
  const customInputs = document.getElementById('customInputs');
  const customButtons = document.getElementById('customButtons');
  const btnFillProfile = document.getElementById('fillProfile');
  const btnClearAll = document.getElementById('clearAll');

  const tblBody = document.querySelector('#tbl tbody');
  const thPS = document.getElementById('thPS');
  const thPNo = document.getElementById('thPNo');
  const sumKwhEl = document.getElementById('sumKwh');
  const sumCostSEl = document.getElementById('sumCostS');
  const sumCostNEl = document.getElementById('sumCostN');
  const sumDeltaEl = document.getElementById('sumDelta');

  let dataset, barChart, priceChart, period = 'last12', useMode = 'bolig'; // 'bolig' | 'fritid'

  function setAreas(areas){
    areaEl.innerHTML = "";
    for(const a of areas){
      const opt = document.createElement('option');
      opt.value = a; opt.textContent = AREA_INFO[a] || a;
      areaEl.appendChild(opt);
    }
    areaEl.value = areas.includes('NO1') ? 'NO1' : (areas[0] || '');
    updateAreaHeaders();
  }
  function updateAreaHeaders(){
    const a = areaEl.value || 'NO?';
    thPS.textContent = `kr/kWh ${a} m. strømstøtte`;
    thPNo.textContent = `kr/kWh ${a} u. strømstøtte`;
  }

  function setPeriodChips(years){
    periodChips.innerHTML = "";
    const mk = (val, label) => {
      const b = document.createElement('button');
      b.className = 'chip'; b.textContent = label; b.dataset.val = val;
      b.onclick = () => { period = val; updateActiveChips(); recalc(); };
      periodChips.appendChild(b);
    };
    mk('last12', 'Siste 12 mnd');
    years.slice().reverse().forEach(y => mk(String(y), String(y)));
    updateActiveChips();
  }
  function updateActiveChips(){
    [...periodChips.querySelectorAll('.chip')].forEach(x=>x.classList.toggle('active', x.dataset.val===String(period)));
  }

  function setInsulChips(){
    insulChips.innerHTML = "";
    const presets = [
      { key:'poor',   label:'Dårlig', preset:+30 },
      { key:'normal', label:'Normal', preset: 0  },
      { key:'good',   label:'God',    preset:-25 },
    ];
    presets.forEach(p=>{
      const b = document.createElement('button');
      b.className = 'chip'; b.textContent = p.label; b.dataset.val = p.preset;
      b.onclick = () => { shapeEl.value = String(p.preset); shapeOut.textContent = `${p.preset}%`; highlightInsul(p.preset); recalc(); };
      insulChips.appendChild(b);
    });
    highlightInsul(0);
  }
  function highlightInsul(percent){
    [...insulChips.querySelectorAll('.chip')].forEach(x=>{
      x.classList.toggle('active', Number(x.dataset.val) === Number(percent));
    });
  }

  function setUseChips(){
    useChips.innerHTML = "";
    [
      { val:'bolig',  label:'Bolig' },
      { val:'fritid', label:'Fritidsbolig' }
    ].forEach(p=>{
      const b = document.createElement('button');
      b.className = 'chip'; b.textContent = p.label; b.dataset.val = p.val;
      b.onclick = () => { useMode = p.val; updateUseChips(); recalc(); };
      useChips.appendChild(b);
    });
    updateUseChips();
  }
  function updateUseChips(){
    [...useChips.querySelectorAll('.chip')].forEach(x=>x.classList.toggle('active', x.dataset.val===useMode));
  }

  function renderCustomInputs(enable, monthlyKWh){
    customInputs.style.display = enable ? 'grid' : 'none';
    customButtons.style.display = enable ? 'flex' : 'none';
    if(!enable) return;
    if (customInputs.childElementCount === 0) {
      for(let i=0;i<12;i++){
        const wrap = document.createElement('div');
        const lab = document.createElement('label'); lab.textContent = MONTHS[i];
        const inp = document.createElement('input');
        inp.type = 'number'; inp.min = '0'; inp.step = '1'; inp.value = '';
        inp.id = `m_${i}`;
        wrap.appendChild(lab); wrap.appendChild(inp);
        customInputs.appendChild(wrap);
      }
      btnFillProfile.onclick = () => {
        for(let i=0;i<12;i++) document.getElementById(`m_${i}`).value = Math.round(monthlyKWh[i]);
        recalc();
      };
      btnClearAll.onclick = () => {
        for(let i=0;i<12;i++) document.getElementById(`m_${i}`).value = '';
        recalc();
      };
    }
  }
  function readCustomKwh(defaultMonthly){
    const arr = [];
    for(let i=0;i<12;i++){
      const v = document.getElementById(`m_${i}`)?.value;
      arr.push(v==='' || v==null ? defaultMonthly[i] : Number(v));
    }
    return arr;
  }

  function renderTable(rows, sums){
    tblBody.innerHTML = "";
    for(const r of rows){
      const tr = document.createElement('tr');
      const diff = r.d;
      tr.innerHTML = `
        <td>${r.month}</td>
        <td>${Math.round(r.kwh).toLocaleString('nb-NO')}</td>
        <td>${r.pS.toFixed(2)}</td>
        <td>${r.pNo.toFixed(2)}</td>
        <td>${r.pN.toFixed(2)}</td>
        <td>${kroner(r.cS)}</td>
        <td>${kroner(r.cN)}</td>
        <td style="color:${diff<0?'#16a34a':(diff>0?'#dc2626':'inherit')}">${diff<0?'-':''}${kroner(Math.abs(diff))}</td>`;
      tblBody.appendChild(tr);
    }
    sumKwhEl.textContent = Math.round(sums.kwh).toLocaleString('nb-NO');
    sumCostSEl.textContent = kroner(sums.cS);
    sumCostNEl.textContent = kroner(sums.cN);
    sumDeltaEl.textContent  = (sums.d<0?'-':'') + kroner(Math.abs(sums.d));
    sumSEl.textContent = kroner(sums.cS);
    sumNEl.textContent = kroner(sums.cN);

    // Besparelse i oppsummering + setning
    const saving = sums.cS - sums.cN; // positiv = sparer med Norgespris
    saveOutEl.textContent = (saving>=0? '' : '−') + kroner(Math.abs(saving));
    if (saving >= 0) {
      besparelseTextEl.textContent = `Det er estimert at du sparer ${kroner(saving)} årlig med Norgespris basert på dine valgte forutsetninger.`;
    } else {
      besparelseTextEl.textContent = `Det er estimert at du taper ${kroner(-saving)} årlig med Norgespris basert på dine valgte forutsetninger.`;
    }
  }

  function renderBar(labels, kwh, costS, costN){
    const ctx = document.getElementById('barChart').getContext('2d');
    if(barChart) barChart.destroy();
    const ymaxCost = Math.max(q(costS,0.95), q(costN,0.95)) * 1.15;
    const ymaxKwh = q(kwh,0.95) * 1.25;
    barChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { type:'bar', label:'kWh (forbruk)', data:kwh, yAxisID:'yKwh', backgroundColor:'rgba(31, 41, 55, .25)', borderColor:'#1f2937', borderWidth:1 },
          { type:'bar', label:'Kr spot (m/støtte)', data:costS, yAxisID:'yKr', backgroundColor:'rgba(37, 99, 235, .35)', borderColor:'#2563eb', borderWidth:1 },
          { type:'bar', label:'Kr Norgespris', data:costN, yAxisID:'yKr', backgroundColor:'rgba(22, 163, 74, .35)', borderColor:'#16a34a', borderWidth:1 },
        ]
      },
      options: {
        responsive:true, maintainAspectRatio:false,
        interaction:{ mode:'index', intersect:false },
        plugins:{ legend:{ display:true, position:'top' } },
        scales:{
          yKwh:{ position:'left', title:{display:true, text:'kWh'}, suggestedMax:ymaxKwh, beginAtZero:true, grid:{ drawOnChartArea:false }},
          yKr:{ position:'right', title:{display:true, text:'Kr (inkl. mva)'}, suggestedMax:ymaxCost, beginAtZero:true }
        }
      }
    });
  }

  function renderPriceChart(labels, priceS, priceN){
    const ctx = document.getElementById('priceChart').getContext('2d');
    if(priceChart) priceChart.destroy();
    const ymax = Math.max(q(priceS,0.95), q(priceN,0.95)) * 1.15;
    priceChart = new Chart(ctx, {
      type:'line',
      data:{ labels, datasets:[
        { label:'Spot m/strømstøtte (inkl. mva)', data:priceS, borderColor:'#2563eb', backgroundColor:'rgba(37,99,235,.15)', tension:.15, pointRadius:0, borderWidth:2 },
        { label:'Norgespris (effektiv, inkl. mva)', data:priceN, borderColor:'#16a34a', backgroundColor:'rgba(22,163,74,.15)', tension:.15, pointRadius:0, borderWidth:2 }
      ]},
      options:{
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{ display:true, position:'top' } },
        scales:{ y:{ title:{display:true,text:'kr/kWh (inkl. mva)'}, suggestedMax:ymax, beginAtZero:true } }
      }
    });
  }

  // ---- Recalc (debounced) ----
  const deb = (fn, ms=300) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };

  function recalc(){
    if(!dataset) return;
    updateAreaHeaders();

    const area = areaEl.value;
    const annual = Number(annualEl.value||0);
    const shape = Number(shapeEl.value||0)/100; shapeOut.textContent = `${shapeEl.value}%`;
    highlightInsul(Number(shapeEl.value||0));
    const evOn = evEl.checked; const evKm = Number(evKmEl.value||0);
    evKmEl.disabled = !evOn;

    const defaultMonthly = annualToMonthly(annual, shape, evOn, evKm, useMode);

    if(customToggle.checked){
      renderCustomInputs(true, defaultMonthly);
    } else {
      customInputs.style.display='none'; customButtons.style.display='none';
    }
    const monthlyKWh = customToggle.checked ? readCustomKwh(defaultMonthly) : defaultMonthly;

    const { labels, kwhArr, priceS, priceNo, priceN, costS, costN, table, sums } =
      compute(area, period, dataset.byAreaYear, monthlyKWh);

    renderBar(labels, kwhArr, costS, costN);
    renderTable(table, sums);

    statusEl.textContent = `Viser ${labels.length} måneder for ${AREA_INFO[area]||area}.`;

    // Hele serie for prisgraf (bruk samme kWh per kalendermåned for Norgespris-måling)
    const allList = (()=>{ const ent = dataset.byAreaYear[area]||{}; const ys = Object.keys(ent).map(Number).sort((a,b)=>a-b);
      const out=[]; for(const y of ys){ for(let m=1;m<=12;m++){ const r=ent[y]?.[m]; if(r) out.push({y,m,row:r}); } } return out; })();
    const pLabels = allList.map(o=>`${o.y}-${String(o.m).padStart(2,'0')}`);
    const pS = allList.map(o=>o.row.eff_ex*(1+VAT));
    const pN = allList.map(o=>{
      const k = monthlyKWh[o.m-1]||0;
      const covered = Math.min(k, CAP_KWH), excess = Math.max(0, k - CAP_KWH);
      const spotExEx = Number.isFinite(o.row.spot_ex) ? o.row.spot_ex : o.row.eff_ex;
      return (k>0) ? ((covered*(NORGESPRIS_EX_ORE/100)+excess*spotExEx)*(1+VAT)/k) : fixedIncl();
    });
    renderPriceChart(pLabels, pS, pN);
  }

  // ---- Init ----
  (async function(){
    try{
      dataset = await loadMonthlyAvgs();
      setAreas(dataset.areas);
      setPeriodChips(dataset.years);
      setInsulChips();
      setUseChips();
      recalc();
    }catch(e){
      console.error(e);
      statusEl.textContent = 'Feil ved lasting av data. Sjekk at data/monthly_avgs_v1.csv er tilgjengelig.';
    }
  })();

  // ---- Lyttere ----
  areaEl.addEventListener('change', recalc);
  shapeEl.addEventListener('input', deb(recalc, 120));
  annualEl.addEventListener('input', deb(recalc, 300));
  evEl.addEventListener('change', recalc);
  evKmEl.addEventListener('input', deb(recalc, 200));
  customToggle.addEventListener('change', ()=>{
    const annual = Number(annualEl.value||0);
    const shape = Number(shapeEl.value||0)/100;
    const evOn = evEl.checked;
    const evKm = Number(evKmEl.value||0);
    const m = annualToMonthly(annual, shape, evOn, evKm, useMode);
    renderCustomInputs(customToggle.checked, m);
    recalc();
  });
</script>
</body>
</html>
