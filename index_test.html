<!doctype html>
<html lang="nb">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Norgespris – Steg 1</title>
  <style>
    :root{ --bg:#f7f7f8; --fg:#111; --muted:#6b7280; --card:#fff; --border:#e5e7eb }
    *{ box-sizing:border-box }
    html,body{ margin:0; background:var(--bg); color:var(--fg); font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial }
    .wrap{ max-width:1200px; margin:0 auto; padding:16px }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px }
    .grid{ display:grid; gap:12px } .g3{ grid-template-columns:repeat(3,minmax(0,1fr)) }
    @media (max-width:1000px){ .g3{ grid-template-columns:1fr } }
    h1{ font-size:24px; margin:0 0 8px }
    p{ color:var(--muted); margin:0 0 12px }
    label{ display:block; font-size:13px; color:var(--muted); margin-bottom:6px }
    input[type="number"], select, button{ font:inherit }
    input[type="number"], select{ width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:#fff }
    .chips{ display:flex; gap:8px; flex-wrap:wrap }
    .chip{ padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; cursor:pointer }
    .chip.active{ background:#111; color:#fff; border-color:#111 }
    .muted{ color:var(--muted) }
    .big{ font-size:20px; font-weight:700 }
    .kv{ font-variant-numeric: tabular-nums }
    table{ width:100%; border-collapse:collapse; font-variant-numeric:tabular-nums }
    th,td{ padding:8px 10px; border-bottom:1px solid var(--border); text-align:right }
    th:first-child, td:first-child{ text-align:left }
    .note{ background:#fffaf0; border:1px solid #fde68a; color:#92400e; padding:10px 12px; border-radius:12px }
    .hr{ height:1px; background:var(--border); margin:8px 0 }
  </style>
</head>
<body>
<div class="wrap">
  <h1>Norgespris</h1>
  <p>Legg inn forbruk og sammenlign norgespris mot spotpris m/strømstøtte.</p>

  <div class="card grid g3">
    <div>
      <label for="area">Prisområde</label>
      <select id="area"><option>—</option></select>
      <small class="muted">NO1 er standard hvis tilgjengelig.</small>
    </div>
    <div>
      <label for="annual">Årlig forbruk (kWt)</label>
      <input id="annual" type="number" value="20000" min="0" step="100">
    </div>
    <div>
      <label>Boligtype</label>
      <div id="useChips" class="chips"></div>
      <small class="muted">Bolig: tak 5000 kWt/mnd. Fritidsbolig: 1000 kWt/mnd.</small>
    </div>
    <div>
      <label>Isoleringsgrad</label>
      <div id="insulChips" class="chips"></div>
    </div>
    <div>
      <label>Periode</label>
      <div id="periodChips" class="chips"></div>
      <small class="muted">Siste 12 mnd eller valgt år.</small>
    </div>
    <div>
      <label>Energibærer</label>
      <div id="energyChips" class="chips"></div>
      <small class="muted">Bytt mellom Strøm og Fjernvarme/Nærvarme.</small>
    </div>
  </div>

  <div class="card grid g3" style="margin-top:12px">
    <div>
      <div class="big kv"><b>Estimert strømkostnad</b></div>
      <div class="muted">inkludert mva.</div>
    </div>
    <div>
      <div class="muted">norgespris</div>
      <div class="big kv" id="sumN">–</div>
      <div class="muted" style="margin-top:6px"><b>Besparelse norgespris:</b> <b id="saveOut">–</b></div>
      <div class="muted" id="besparelseText" style="margin-top:6px"></div>
    </div>
    <div>
      <div class="muted"><span id="spotSummaryLabel">spot m/strømstøtte</span></div>
      <div class="big kv" id="sumS">–</div>
      <div id="fritidNote" class="muted" style="margin-top:6px; display:none">Fritidsbolig får ikke strømstøtte.</div>
    </div>
  </div>

  <div class="note" style="margin-top:10px">
    <b>Viktig:</b> Ekskludert nettleie, avgifter og påslag.
  </div>

  <div class="card" style="margin-top:12px">
    <div class="row" style="display:flex;justify-content:space-between;align-items:center">
      <div class="muted">Forbruk og kostnader per måned</div>
      <div id="status" class="muted">Klar</div>
    </div>
    <div class="hr"></div>
    <div style="height:360px"><canvas id="barChart"></canvas></div>
  </div>

  <div class="card" style="margin-top:12px">
    <div style="overflow:auto">
      <table id="tbl">
        <thead>
          <tr>
            <th>Måned</th><th>kWt</th>
            <th id="thPNo">NO? - spotpris (kr/kWt)</th>
            <th id="thPS">NO? - spotpris med strømstøtte (kr/kWt)</th>
            <th>norgespris - effektiv (kr/kWt)</th>
            <th id="thCostS">Kostnad - spotpris med strømstøtte (kr)</th>
            <th>Kostnad - norgespris (kr)</th>
            <th>Besparelse med norgespris (kr)</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td>SUM</td><td id="sumKwh">–</td><td></td><td></td><td></td>
            <td id="sumCostS">–</td><td id="sumCostN">–</td><td id="sumDelta">–</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
      <div id="histTitle" class="muted">Historiske energipriser</div>
      <div class="chips" id="yearJump"></div>
      <div>
        <button id="resetZoom" class="chip">Nullstill zoom</button>
      </div>
    </div>
    <div class="hr"></div>
    <div style="height:300px"><canvas id="priceChart"></canvas></div>
    <div id="forecastNote" class="muted" style="margin-top:8px; display:none; font-size:13px"></div>
  </div>
</div>

<!-- Libs (legges til i senere steg) -->
</body>
</html>
<!doctype html>
<html lang="nb">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Norgespris – Steg 2</title>
<style>
  :root{ --bg:#f7f7f8; --fg:#111; --muted:#6b7280; --card:#fff; --border:#e5e7eb }
  *{ box-sizing:border-box } html,body{ margin:0; background:var(--bg); color:var(--fg); font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial }
  .wrap{ max-width:1200px; margin:0 auto; padding:16px } .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px }
  .grid{ display:grid; gap:12px } .g3{ grid-template-columns:repeat(3,minmax(0,1fr)) } @media (max-width:1000px){ .g3{ grid-template-columns:1fr } }
  h1{ font-size:24px; margin:0 0 8px } p{ color:var(--muted); margin:0 0 12px }
  label{ display:block; font-size:13px; color:var(--muted); margin-bottom:6px }
  input[type="number"], select, button{ font:inherit } input[type="number"], select{ width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:#fff }
  .chips{ display:flex; gap:8px; flex-wrap:wrap } .chip{ padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; cursor:pointer } .chip.active{ background:#111; color:#fff; border-color:#111 }
  .muted{ color:var(--muted) } .big{ font-size:20px; font-weight:700 } .kv{ font-variant-numeric: tabular-nums }
  table{ width:100%; border-collapse:collapse; font-variant-numeric:tabular-nums } th,td{ padding:8px 10px; border-bottom:1px solid var(--border); text-align:right } th:first-child, td:first-child{ text-align:left }
  .note{ background:#fffaf0; border:1px solid #fde68a; color:#92400e; padding:10px 12px; border-radius:12px } .hr{ height:1px; background:var(--border); margin:8px 0 }
  .pos{ color:#16a34a } .neg{ color:#dc2626 }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="wrap">
  <h1>Norgespris</h1>
  <p>Legg inn forbruk og sammenlign norgespris mot spotpris m/strømstøtte.</p>

  <div class="card grid g3">
    <div>
      <label for="area">Prisområde</label>
      <select id="area"></select>
      <small class="muted">NO1 er standard hvis tilgjengelig.</small>
    </div>
    <div>
      <label for="annual">Årlig forbruk (kWt)</label>
      <input id="annual" type="number" value="20000" min="0" step="100">
    </div>
    <div>
      <label>Boligtype</label>
      <div id="useChips" class="chips"></div>
    </div>
    <div>
      <label>Isoleringsgrad</label>
      <div id="insulChips" class="chips"></div>
    </div>
    <div>
      <label>Periode</label>
      <div id="periodChips" class="chips"></div>
      <small class="muted">Siste 12 mnd eller valgt år.</small>
    </div>
    <div>
      <label>Energibærer</label>
      <div id="energyChips" class="chips"></div>
      <small class="muted">Strøm eller Fjernvarme/Nærvarme</small>
    </div>
  </div>

  <div class="card grid g3" style="margin-top:12px">
    <div>
      <div class="big kv"><b>Estimert strømkostnad</b></div>
      <div class="muted">inkludert mva.</div>
    </div>
    <div>
      <div class="muted">norgespris</div>
      <div class="big kv" id="sumN">–</div>
      <div class="muted" style="margin-top:6px"><b>Besparelse norgespris:</b> <b id="saveOut">–</b></div>
      <div class="muted" id="besparelseText" style="margin-top:6px"></div>
    </div>
    <div>
      <div class="muted"><span id="spotSummaryLabel">spot m/strømstøtte</span></div>
      <div class="big kv" id="sumS">–</div>
      <div id="fritidNote" class="muted" style="margin-top:6px; display:none">Fritidsbolig får ikke strømstøtte.</div>
    </div>
  </div>

  <div class="note" style="margin-top:10px"><b>Viktig:</b> Ekskludert nettleie, avgifter og påslag.</div>

  <div class="card" style="margin-top:12px">
    <div class="row" style="display:flex;justify-content:space-between;align-items:center">
      <div class="muted">Forbruk og kostnader per måned</div>
      <div id="status" class="muted">Laster data …</div>
    </div>
    <div class="hr"></div>
    <div style="height:360px"><canvas id="barChart"></canvas></div>
  </div>

  <div class="card" style="margin-top:12px">
    <div style="overflow:auto">
      <table id="tbl">
        <thead>
          <tr>
            <th>Måned</th><th>kWt</th>
            <th id="thPNo">NO? - spotpris (kr/kWt)</th>
            <th id="thPS">NO? - spotpris med strømstøtte (kr/kWt)</th>
            <th>norgespris - effektiv (kr/kWt)</th>
            <th id="thCostS">Kostnad - spotpris med strømstøtte (kr)</th>
            <th>Kostnad - norgespris (kr)</th>
            <th>Besparelse med norgespris (kr)</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td>SUM</td><td id="sumKwh">–</td><td></td><td></td><td></td>
            <td id="sumCostS">–</td><td id="sumCostN">–</td><td id="sumDelta">–</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
      <div id="histTitle" class="muted">Historiske energipriser</div>
      <div class="chips" id="yearJump"></div>
      <div><button id="resetZoom" class="chip">Nullstill zoom</button></div>
    </div>
    <div class="hr"></div>
    <div style="height:300px"><canvas id="priceChart"></canvas></div>
    <div id="forecastNote" class="muted" style="margin-top:8px; display:none; font-size:13px"></div>
  </div>
</div>

<script>
const VAT = 0.25;
const NORGESPRIS_EX_ORE = 40;
const CAP_BOLIG = 5000, CAP_FRITID = 1000;
const MONTHS = ["Jan","Feb","Mar","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Des"];
const AREA_LABELS = { NO1:"NO1 - Østlandet", NO2:"NO2 - Sørlandet", NO3:"NO3 - Midt-Norge", NO4:"NO4 - Nord-Norge", NO5:"NO5 - Vestlandet" };
// NB: NO6 utelates

const BASE_WINTER = [13.5,12,10,8.5,7,5.5,4.5,5,7,8.5,10,12];
const normalizeProfile = p => { const s = p.reduce((a,b)=>a+b,0)||1; return p.map(x => x * 100 / s); };
function shapedProfile(shape){ const base=normalizeProfile(BASE_WINTER), u=100/12; return base.map(p => u + (p-u)*(1+shape)); }
const SUMMER_MONTHS = new Set([4,5,6,7,8,9]);
function applySeasonMode(p,mode){ const mult=p.map((_,i)=>{const m=i+1, s=SUMMER_MONTHS.has(m); if(mode==='sommer')return s?1:0.2; if(mode==='vinter')return s?0.1:1; return 1;}); const adj=p.map((v,i)=>v*mult[i]); const S=adj.reduce((a,b)=>a+b,0)||1; return adj.map(x=>x*100/S); }
function annualToMonthly(annual, shapePct, useMode, seasonMode){ let prof=shapedProfile(shapePct/100); if(useMode==='fritid') prof=applySeasonMode(prof, seasonMode); return prof.map(p=> (annual||0)*(p/100)); }

const kroner = n => (n||0).toLocaleString("nb-NO",{ style:"currency", currency:"NOK", maximumFractionDigits:0 });
const fixedIncl = () => (NORGESPRIS_EX_ORE/100) * (1+VAT);
const q = (arr,p=0.95) => { const a=arr.filter(Number.isFinite).slice().sort((x,y)=>x-y); if(!a.length) return 1; const i=Math.floor((a.length-1)*p); return a[i]; };

async function loadCSV(path){
  const r = await fetch(path, { cache:'no-store' });
  if(!r.ok) throw new Error('Kunne ikke hente '+path);
  let txt = (await r.text()).replace(/^\uFEFF/, '').replace(/\r\n?/g,'\n').trim();
  const first = txt.split('\n',1)[0]; const seps=[',',';','\t','|'];
  const sep = seps.reduce((best,s)=>{const c=(first.match(new RegExp('\\'+s,'g'))||[]).length; return c>best.c?{s,c}:best;},{s:',',c:0}).s;
  const [head,...lines]=txt.split('\n').filter(l=>l.trim()); const headers=head.split(sep).map(h=>h.toLowerCase().trim());
  const idx = Object.fromEntries(headers.map((h,i)=>[h,i]));
  const need = ['area','year','month','avg_effective_nok_ex'];
  const miss = need.filter(k=>!(k in idx)); if(miss.length) throw new Error('Mangler kolonner: '+miss.join(', '));
  const hasSpot = 'avg_spot_nok_ex' in idx;

  const sample=(lines[0]||'').split(sep).map(s=>s.trim());
  const usesComma = [idx['avg_effective_nok_ex'], hasSpot?idx['avg_spot_nok_ex']:-1]
    .map(i=>i>=0?sample[i]||'':'').some(v=> /,\d{1,3}$/.test(v) || (v.includes(',') && !v.includes('.')));
  const toNum = s => { let t=String(s??'').trim().replace(/\u00A0/g,'').replace(/\s/g,''); if(usesComma){ t=t.replace(/\./g,'').replace(',','.'); } return Number(t); };

  const rows=[];
  for(const line of lines){
    const c=line.split(sep);
    const area=(c[idx.area]||'').trim().toUpperCase();
    if(area==='NO6') continue; // utelat NO6
    const y=toNum(c[idx.year]), m=toNum(c[idx.month]);
    const eff_ex=toNum(c[idx['avg_effective_nok_ex']]);
    const spot_ex=hasSpot?toNum(c[idx['avg_spot_nok_ex']]):NaN;
    if(!area||!Number.isFinite(y)||!Number.isFinite(m)) continue;
    rows.push({area,year:y,month:m,eff_ex,spot_ex});
  }
  const byAreaYear={}; const areas=new Set(); const years=new Set();
  for(const r of rows){ areas.add(r.area); years.add(r.year); byAreaYear[r.area]??={}; byAreaYear[r.area][r.year]??={}; byAreaYear[r.area][r.year][r.month]=r; }
  return { byAreaYear, areas:[...areas].sort(), years:[...years].sort((a,b)=>a-b) };
}

function monthsInPeriod(byAreaYear, area, period){
  const ent=byAreaYear[area]||{}; const ys=Object.keys(ent).map(Number).sort((a,b)=>a-b); const list=[];
  for(const y of ys){ for(let m=1;m<=12;m++){ const row=ent[y]?.[m]; if(row) list.push({y:m?y:y,m,row}); } }
  if(period==='last12') return list.slice(-12);
  const y=Number(period);
  return Array.from({length:12},(_,i)=>({y, m:i+1, row:ent[y]?.[i+1]})).filter(x=>x.row);
}

function calcMonthlySupportedIncl(row, energyMode){
  // energyMode: 'strom' => bruk eff_ex (allerede timeskorrigert i CSV)
  // energyMode: 'fjernvarme' => støtte beregnes månedlig fra spot_ex
  const spotIncl = (Number.isFinite(row.spot_ex)?row.spot_ex:row.eff_ex)*(1+VAT);
  if(energyMode==='strom'){
    return row.eff_ex*(1+VAT);
  } else {
    // Månedlig støtte: 90% over 0,94 kr/kWh (inkl mva), minimum 0
    const over = Math.max(0, spotIncl - 0.94);
    return spotIncl - 0.90*over;
  }
}

function compute(area, period, byAreaYear, monthlyKWt, useMode, energyMode){
  const fixedEx = NORGESPRIS_EX_ORE/100, cap = useMode==='fritid'?CAP_FRITID:CAP_BOLIG;
  const ms = monthsInPeriod(byAreaYear, area, period);
  const labels=[], kwhArr=[], priceS=[], priceNo=[], priceN=[], costS=[], costN=[], table=[];
  for(const {y,m,row} of ms){
    const k = monthlyKWt[m-1]||0;
    const priceEffIncl = calcMonthlySupportedIncl(row, energyMode);
    const priceNoIncl  = (Number.isFinite(row.spot_ex)?row.spot_ex:row.eff_ex)*(1+VAT);

    const covered=Math.min(k,cap), excess=Math.max(0,k-cap);
    const spotExEx = Number.isFinite(row.spot_ex)?row.spot_ex:row.eff_ex; // eks mva
    const priceNorgIncl = k>0 ? ((covered*fixedEx + excess*spotExEx)*(1+VAT)/k) : fixedIncl();

    const comparePriceIncl = (useMode==='fritid') ? priceNoIncl : priceEffIncl;

    const cS=k*comparePriceIncl, cN=k*priceNorgIncl;

    labels.push(`${y}-${String(m).padStart(2,'0')}`);
    kwhArr.push(k); priceS.push(priceEffIncl); priceNo.push(priceNoIncl); priceN.push(priceNorgIncl);
    costS.push(cS); costN.push(cN);
    table.push({ month:`${MONTHS[m-1]} ${y}`, kwh:k, pS:priceEffIncl, pNo:priceNoIncl, pN:priceNorgIncl, cS, cN, d:cS-cN });
  }
  const sums={ kwh:kwhArr.reduce((a,b)=>a+b,0), cS:costS.reduce((a,b)=>a+b,0), cN:costN.reduce((a,b)=>a+b,0) };
  sums.d = sums.cS - sums.cN;
  return { labels, kwhArr, priceS, priceNo, priceN, costS, costN, table, sums };
}
</script>

<script>
let dataset=null, barChart=null, priceChart=null;
let period='last12', useMode='bolig', energyMode='strom', shapePct=0, seasonMode='helars';

const areaEl=document.getElementById('area');
const annualEl=document.getElementById('annual');
const useChips=document.getElementById('useChips');
const insulChips=document.getElementById('insulChips');
const periodChips=document.getElementById('periodChips');
const energyChips=document.getElementById('energyChips');
const spotSummaryLabel=document.getElementById('spotSummaryLabel');
const fritidNote=document.getElementById('fritidNote');
const statusEl=document.getElementById('status');
const histTitleEl=document.getElementById('histTitle');
const forecastNote=document.getElementById('forecastNote');

const sumNEl=document.getElementById('sumN'), sumSEl=document.getElementById('sumS'), saveOutEl=document.getElementById('saveOut'), besparelseTextEl=document.getElementById('besparelseText');
const tblBody=document.querySelector('#tbl tbody'); const thPS=document.getElementById('thPS'); const thPNo=document.getElementById('thPNo'); const thCostSEl=document.getElementById('thCostS');
const sumKwhEl=document.getElementById('sumKwh'); const sumCostSEl=document.getElementById('sumCostS'); const sumCostNEl=document.getElementById('sumCostN'); const sumDeltaEl=document.getElementById('sumDelta');

function setAreas(areas){
  areaEl.innerHTML='';
  areas.forEach(a=>{ const o=document.createElement('option'); o.value=a; o.textContent=AREA_LABELS[a]||a; areaEl.appendChild(o); });
  areaEl.value = areas.includes('NO1')? 'NO1' : areas[0] || '';
  updateAreaHeaders(); updateHistTitle();
}
function updateAreaHeaders(){ const a=areaEl.value||'NO?'; thPS.textContent=`${a} - spotpris med strømstøtte (kr/kWt)`; thPNo.textContent=`${a} - spotpris (kr/kWt)`; }
function updateHistTitle(){ const a=areaEl.value||'NO?'; histTitleEl.textContent=`Historiske energipriser ${a}`; }

function setUseChips(){
  useChips.innerHTML='';
  [{val:'bolig',label:'Bolig'},{val:'fritid',label:'Fritidsbolig'}].forEach(p=>{
    const b=document.createElement('button'); b.className='chip'; b.textContent=p.label; b.dataset.val=p.val;
    b.onclick=()=>{ useMode=p.val; updateUseChips(); recalc(); };
    useChips.appendChild(b);
  });
  updateUseChips();
}
function updateUseChips(){ [...useChips.querySelectorAll('.chip')].forEach(x=>x.classList.toggle('active', x.dataset.val===useMode)); }

function setInsulChips(){
  insulChips.innerHTML='';
  [{label:'Dårlig',val:+30},{label:'Normal',val:0},{label:'God',val:-25}].forEach(p=>{
    const b=document.createElement('button'); b.className='chip'; b.textContent=p.label; b.dataset.val=p.val;
    b.onclick=()=>{ shapePct=p.val; highlightInsul(p.val); recalc(); };
    insulChips.appendChild(b);
  }); highlightInsul(0);
}
function highlightInsul(v){ [...insulChips.querySelectorAll('.chip')].forEach(x=>x.classList.toggle('active', Number(x.dataset.val)===Number(v))); }

function setEnergyChips(){
  energyChips.innerHTML='';
  [{val:'strom',label:'Strøm'},{val:'fjernvarme',label:'Fjernvarme/Nærvarme'}].forEach(p=>{
    const b=document.createElement('button'); b.className='chip'; b.textContent=p.label; b.dataset.val=p.val;
    b.onclick=()=>{ energyMode=p.val; recalc(); };
    energyChips.appendChild(b);
  });
  [...energyChips.children][0]?.classList.add('active');
}
function updateEnergyChips(){ [...energyChips.querySelectorAll('.chip')].forEach(x=>x.classList.toggle('active', x.dataset.val===energyMode)); }

function setPeriodChips(years){
  periodChips.innerHTML='';
  const mk=(val,label)=>{ const b=document.createElement('button'); b.className='chip'; b.textContent=label; b.dataset.val=val; b.onclick=()=>{ period=val; updatePeriodActive(); recalc(); }; periodChips.appendChild(b); };
  mk('last12','Siste 12 mnd'); years.slice().reverse().forEach(y=>mk(String(y), String(y)));
  updatePeriodActive();
}
function updatePeriodActive(){ [...periodChips.querySelectorAll('.chip')].forEach(x=>x.classList.toggle('active', x.dataset.val===String(period))); }

function updateSpotLabels(){
  const isFritid = (useMode==='fritid');
  spotSummaryLabel.textContent = isFritid ? 'spot uten strømstøtte' : (energyMode==='fjernvarme' ? 'spot m/strømstøtte (måned)' : 'spot m/strømstøtte');
  thCostSEl.textContent = `Kostnad - ${isFritid ? 'spotpris uten strømstøtte' : (energyMode==='fjernvarme' ? 'spotpris m/strømstøtte (måned)' : 'spotpris med strømstøtte')} (kr)`;
  fritidNote.style.display = isFritid ? 'block' : 'none';
}

function getMonthlyArray(){
  const annual = Number(annualEl.value||0);
  return annualToMonthly(annual, shapePct, useMode, seasonMode);
}

function renderTable(rows, sums){
  const body=tblBody; body.innerHTML='';
  for(const r of rows){
    const cls = r.d>0?'pos':(r.d<0?'neg':''); const sign=r.d<0?'-':'';
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${r.month}</td><td>${Math.round(r.kwh).toLocaleString('nb-NO')}</td>
      <td>${r.pNo.toFixed(2)}</td><td>${r.pS.toFixed(2)}</td><td>${r.pN.toFixed(2)}</td>
      <td>${kroner(r.cS)}</td><td>${kroner(r.cN)}</td><td class="${cls}">${sign}${kroner(Math.abs(r.d))}</td>`;
    body.appendChild(tr);
  }
  sumKwhEl.textContent=Math.round(sums.kwh).toLocaleString('nb-NO');
  sumCostSEl.textContent=kroner(sums.cS); sumCostNEl.textContent=kroner(sums.cN);
  sumDeltaEl.textContent=(sums.d<0?'-':'')+kroner(Math.abs(sums.d)); sumDeltaEl.className=sums.d>0?'pos':(sums.d<0?'neg':'');
  sumSEl.textContent=kroner(sums.cS); sumNEl.textContent=kroner(sums.cN);
  saveOutEl.textContent=(sums.d<0?'-':'')+kroner(Math.abs(sums.d)); saveOutEl.className=sums.d>0?'pos':(sums.d<0?'neg':'');
  besparelseTextEl.textContent = (sums.d>=0) ? `Estimert besparelse: ${kroner(sums.d)} årlig.` : `Estimert tap: ${kroner(-sums.d)} årlig.`;
}

function renderBar(labels,kwh,cS,cN){
  const ctx=document.getElementById('barChart').getContext('2d');
  if(window.barChart) window.barChart.destroy();
  window.barChart=new Chart(ctx,{ data:{labels, datasets:[
    {type:'bar',label:'Forbruk (kWt)',data:kwh,yAxisID:'yKwh',backgroundColor:'rgba(107,114,128,.35)',borderColor:'#6b7280',borderWidth:1,categoryPercentage:0.6,barPercentage:0.6,order:0},
    {type:'bar',label:'Kostnad spot',data:cS,yAxisID:'yKr',backgroundColor:'rgba(37,99,235,.45)',borderColor:'#2563eb',borderWidth:1,categoryPercentage:0.7,barPercentage:0.7,order:1},
    {type:'bar',label:'Kostnad norgespris',data:cN,yAxisID:'yKr',backgroundColor:'rgba(22,163,74,.45)',borderColor:'#16a34a',borderWidth:1,categoryPercentage:0.7,barPercentage:0.7,order:1}
  ]}, options:{ responsive:true, maintainAspectRatio:false, interaction:{mode:'index',intersect:false}, plugins:{legend:{position:'top'}},
    scales:{ yKwh:{position:'left',title:{display:true,text:'kWt'}, beginAtZero:true, grid:{drawOnChartArea:false}},
             yKr:{position:'right',title:{display:true,text:'Kr (inkl. mva)'}, beginAtZero:true} } }});
}

function renderPrice(labels,pS,pN,pNo,area){
  const ctx=document.getElementById('priceChart').getContext('2d');
  if(window.priceChart) window.priceChart.destroy();
  window.priceChart=new Chart(ctx,{ type:'line', data:{labels, datasets:[
    {label:`${area} spot u/støtte`, data:pNo, borderColor:'#9ca3af', backgroundColor:'rgba(156,163,175,.15)', tension:.15, pointRadius:0, borderWidth:2},
    {label:`${area} spot m/støtte`, data:pS, borderColor:'#2563eb', backgroundColor:'rgba(37,99,235,.15)', tension:.15, pointRadius:0, borderWidth:2},
    {label:'norgespris (effektiv)', data:pN, borderColor:'#16a34a', backgroundColor:'rgba(22,163,74,.15)', tension:.15, pointRadius:0, borderWidth:2}
  ]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'top'}}, scales:{ y:{title:{display:true,text:'kr/kWt inkl. mva'}, beginAtZero:true }}}});
}

function recalc(){
  if(!dataset) return;
  updateEnergyChips(); updateSpotLabels(); updateAreaHeaders(); updateHistTitle();
  const area=areaEl.value; const monthly=getMonthlyArray();
  const {labels,kwhArr,priceS,priceNo,priceN,costS,costN,table,sums} = compute(area, period, dataset.byAreaYear, monthly, useMode, energyMode);
  renderBar(labels,kwhArr,costS,costN); renderTable(table,sums);

  // pris-graf: kjør hele serien i valgt område
  const ent=dataset.byAreaYear[area]||{}; const ys=Object.keys(ent).map(Number).sort((a,b)=>a-b);
  const all=[]; for(const y of ys){ for(let m=1;m<=12;m++){ const r=ent[y]?.[m]; if(r) all.push({y,m,row:r}); } }
  const pLabels=all.map(o=>`${o.y}-${String(o.m).padStart(2,'0')}`);
  const pS=all.map(o=>calcMonthlySupportedIncl(o.row, energyMode));
  const pNo=all.map(o=>(Number.isFinite(o.row.spot_ex)?o.row.spot_ex:o.row.eff_ex)*(1+VAT));
  const cap = useMode==='fritid'?CAP_FRITID:CAP_BOLIG;
  const pN=all.map(o=>{ const k=monthly[o.m-1]||0; const covered=Math.min(k,cap), excess=Math.max(0,k-cap); const spotExEx=Number.isFinite(o.row.spot_ex)?o.row.spot_ex:o.row.eff_ex; return k>0?((covered*(NORGESPRIS_EX_ORE/100)+excess*spotExEx)*(1+VAT)/k):fixedIncl(); });
  renderPrice(pLabels,pS,pN,pNo,area);

  statusEl.textContent=`Viser ${labels.length} mnd for ${area}.`;
  forecastNote.style.display='none'; // ingen prognoser i steg 2
}

(async function init(){
  try{
    dataset = await loadCSV('data/monthly_avgs_v1.csv');
    setAreas(dataset.areas); setUseChips(); setInsulChips(); setEnergyChips(); setPeriodChips(dataset.years);
    areaEl.addEventListener('change', recalc);
    annualEl.addEventListener('input', ()=>recalc());
    recalc();
  }catch(e){ console.error(e); document.getElementById('status').textContent='Feil ved lasting av data.'; }
})();
</script>
</body>
</html>
<!doctype html>
<html lang="nb">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Norgespris – Steg 3 (med futures)</title>
<style>
  :root{ --bg:#f7f7f8; --fg:#111; --muted:#6b7280; --card:#fff; --border:#e5e7eb }
  *{ box-sizing:border-box } html,body{ margin:0; background:var(--bg); color:var(--fg); font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial }
  .wrap{ max-width:1200px; margin:0 auto; padding:16px } .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px }
  .grid{ display:grid; gap:12px } .g3{ grid-template-columns:repeat(3,minmax(0,1fr)) } @media (max-width:1000px){ .g3{ grid-template-columns:1fr } }
  h1{ font-size:24px; margin:0 0 8px } p{ color:var(--muted); margin:0 0 12px }
  label{ display:block; font-size:13px; color:var(--muted); margin-bottom:6px }
  input[type="number"], select, button{ font:inherit } input[type="number"], select{ width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:#fff }
  .chips{ display:flex; gap:8px; flex-wrap:wrap } .chip{ padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; cursor:pointer } .chip.active{ background:#111; color:#fff; border-color:#111 }
  .muted{ color:var(--muted) } .big{ font-size:20px; font-weight:700 } .kv{ font-variant-numeric: tabular-nums }
  table{ width:100%; border-collapse:collapse; font-variant-numeric:tabular-nums } th,td{ padding:8px 10px; border-bottom:1px solid var(--border); text-align:right } th:first-child, td:first-child{ text-align:left }
  .note{ background:#fffaf0; border:1px solid #fde68a; color:#92400e; padding:10px 12px; border-radius:12px } .hr{ height:1px; background:var(--border); margin:8px 0 }
  .pos{ color:#16a34a } .neg{ color:#dc2626 }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="wrap">
  <h1>Norgespris</h1>
  <p>Historikk + prognoser (futures). 2025 = historikk t.o.m. aug, deretter prognoser sep–des.</p>

  <div class="card grid g3">
    <div>
      <label for="area">Prisområde</label>
      <select id="area"></select>
      <small class="muted">NO6 utelates.</small>
    </div>
    <div>
      <label for="annual">Årlig forbruk (kWt)</label>
      <input id="annual" type="number" value="20000" min="0" step="100">
    </div>
    <div>
      <label>Boligtype</label>
      <div id="useChips" class="chips"></div>
    </div>
    <div>
      <label>Isoleringsgrad</label>
      <div id="insulChips" class="chips"></div>
    </div>
    <div>
      <label>Periode</label>
      <div id="periodChips" class="chips"></div>
      <small class="muted">Siste 12 mnd, år – eller 2026 (Prognoser)</small>
    </div>
    <div>
      <label>Energibærer</label>
      <div id="energyChips" class="chips"></div>
    </div>
  </div>

  <div class="card grid g3" style="margin-top:12px">
    <div>
      <div class="big kv"><b>Estimert strømkostnad</b></div>
      <div class="muted">inkludert mva.</div>
    </div>
    <div>
      <div class="muted">norgespris</div>
      <div class="big kv" id="sumN">–</div>
      <div class="muted" style="margin-top:6px"><b>Besparelse norgespris:</b> <b id="saveOut">–</b></div>
      <div class="muted" id="besparelseText" style="margin-top:6px"></div>
    </div>
    <div>
      <div class="muted"><span id="spotSummaryLabel">spot m/strømstøtte</span></div>
      <div class="big kv" id="sumS">–</div>
      <div id="fritidNote" class="muted" style="margin-top:6px; display:none">Fritidsbolig får ikke strømstøtte.</div>
    </div>
  </div>

  <div class="note" style="margin-top:10px"><b>Viktig:</b> Ekskludert nettleie, avgifter og påslag.</div>

  <div class="card" style="margin-top:12px">
    <div class="row" style="display:flex;justify-content:space-between;align-items:center">
      <div class="muted">Forbruk og kostnader per måned</div>
      <div id="status" class="muted">Laster data …</div>
    </div>
    <div class="hr"></div>
    <div style="height:360px"><canvas id="barChart"></canvas></div>
  </div>

  <div class="card" style="margin-top:12px">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
      <div id="histTitle" class="muted">Historiske energipriser</div>
      <div class="chips" id="yearJump"></div>
      <div><button id="resetZoom" class="chip">Nullstill zoom</button></div>
    </div>
    <div class="hr"></div>
    <div style="height:300px"><canvas id="priceChart"></canvas></div>
    <div id="forecastNote" class="muted" style="margin-top:8px; display:none; font-size:13px"></div>
  </div>
</div>

<script>
// --- konstanter og helpers (som i steg 2) ---
const VAT=0.25, NORGESPRIS_EX_ORE=40, CAP_BOLIG=5000, CAP_FRITID=1000;
const MONTHS=["Jan","Feb","Mar","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Des"];
const AREA_LABELS={ NO1:"NO1 - Østlandet", NO2:"NO2 - Sørlandet", NO3:"NO3 - Midt-Norge", NO4:"NO4 - Nord-Norge", NO5:"NO5 - Vestlandet" };
const BASE_WINTER=[13.5,12,10,8.5,7,5.5,4.5,5,7,8.5,10,12];
const SUMMER_MONTHS=new Set([4,5,6,7,8,9]);
const normalizeProfile=p=>{const s=p.reduce((a,b)=>a+b,0)||1; return p.map(x=>x*100/s);};
function shapedProfile(shape){const b=normalizeProfile(BASE_WINTER),u=100/12; return b.map(p=>u+(p-u)*(1+shape));}
function applySeasonMode(p,mode){const mult=p.map((_,i)=>{const m=i+1,s=SUMMER_MONTHS.has(m); if(mode==='sommer')return s?1:0.2; if(mode==='vinter')return s?0.1:1; return 1;}); const adj=p.map((v,i)=>v*mult[i]); const S=adj.reduce((a,b)=>a+b,0)||1; return adj.map(x=>x*100/S);}
function annualToMonthly(annual,shapePct,useMode,seasonMode){let prof=shapedProfile(shapePct/100); if(useMode==='fritid') prof=applySeasonMode(prof,seasonMode); return prof.map(p=>(annual||0)*(p/100));}
const kroner=n=>(n||0).toLocaleString("nb-NO",{style:"currency",currency:"NOK",maximumFractionDigits:0});
const fixedIncl=()=> (NORGESPRIS_EX_ORE/100)*(1+VAT);

async function loadCSV(path){
  const r=await fetch(path,{cache:'no-store'}); if(!r.ok) throw new Error('Kunne ikke hente '+path);
  let txt=(await r.text()).replace(/^\uFEFF/,'').replace(/\r\n?/g,'\n').trim();
  const first=txt.split('\n',1)[0], seps=[',',';','\t','|'];
  const sep=seps.reduce((b,s)=>{const c=(first.match(new RegExp('\\'+s,'g'))||[]).length; return c>b.c?{s,c}:b;},{s:',',c:0}).s;
  const [head,...lines]=txt.split('\n').filter(l=>l.trim()); const headers=head.split(sep).map(h=>h.toLowerCase().trim());
  const idx=Object.fromEntries(headers.map((h,i)=>[h,i])); const hasSpot='avg_spot_nok_ex' in idx;
  const sample=(lines[0]||'').split(sep).map(s=>s.trim());
  const usesComma=[idx['avg_effective_nok_ex'],hasSpot?idx['avg_spot_nok_ex']:-1].map(i=>i>=0?sample[i]||'':'').some(v=> /,\d{1,3}$/.test(v)||(v.includes(',')&&!v.includes('.')));
  const toNum = s=>{ let t=String(s??'').trim().replace(/\u00A0/g,'').replace(/\s/g,''); if(usesComma){ t=t.replace(/\./g,'').replace(',','.'); } return Number(t); };
  const rows=[]; for(const line of lines){
    const c=line.split(sep); const area=(c[idx.area]||'').trim().toUpperCase(); if(area==='NO6') continue;
    const y=toNum(c[idx.year]), m=toNum(c[idx.month]); const eff_ex=toNum(c[idx['avg_effective_nok_ex']]); const spot_ex=hasSpot?toNum(c[idx['avg_spot_nok_ex']]):NaN;
    if(!area||!Number.isFinite(y)||!Number.isFinite(m)) continue; rows.push({area,year:y,month:m,eff_ex,spot_ex});
  }
  const byAreaYear={}, areas=new Set(), years=new Set();
  for(const r2 of rows){ areas.add(r2.area); years.add(r2.year); byAreaYear[r2.area]??={}; byAreaYear[r2.area][r2.year]??={}; byAreaYear[r2.area][r2.year][r2.month]=r2; }
  return { byAreaYear, areas:[...areas].sort(), years:[...years].sort((a,b)=>a-b) };
}

function calcMonthlySupportedIncl(row, energyMode){
  const spotIncl=(Number.isFinite(row.spot_ex)?row.spot_ex:row.eff_ex)*(1+VAT);
  if(energyMode==='strom'){ return row.eff_ex*(1+VAT); }
  const over=Math.max(0, spotIncl - 0.94);
  return spotIncl - 0.90*over;
}

// MERGE: 2025 = historikk Jan–Aug + futures Sep–Des. 2026 (Prognoser) = futures.
function monthsForPeriodMerged(area, period, hist, fut){
  const out=[];
  if(period==='last12'){
    // ta siste 12 fra historikk (evt. supplere fra futures om mangler)
    const allHist=[]; const ent=hist.byAreaYear[area]||{};
    Object.keys(ent).map(Number).sort((a,b)=>a-b).forEach(y=>{ for(let m=1;m<=12;m++){ const r=ent[y]?.[m]; if(r) allHist.push({y,m,row:r}); } });
    if(allHist.length>=12) return allHist.slice(-12);
    // hvis få måneder historikk, fylle opp fra futures
    const allFut=[]; const enf=fut.byAreaYear[area]||{};
    Object.keys(enf).map(Number).sort((a,b)=>a-b).forEach(y=>{ for(let m=1;m<=12;m++){ const r=enf[y]?.[m]; if(r) allFut.push({y,m,row:r}); } });
    return [...allHist, ...allFut].slice(-12);
  }
  const y = Number(period);
  if(y===2026){
    // kun prognoser
    const enf=fut.byAreaYear[area]||{}; const rows=[];
    for(let m=1;m<=12;m++){ const r=enf[2026]?.[m]; if(r) rows.push({y:2026,m,row:r}); }
    return rows;
  }
  if(y===2025){
    const enh=hist.byAreaYear[area]||{}; const enf=fut.byAreaYear[area]||{};
    const rows=[];
    for(let m=1;m<=8;m++){ const r=enh[2025]?.[m]; if(r) rows.push({y:2025,m,row:r}); }
    for(let m=9;m<=12;m++){ const r=enf[2025]?.[m]; if(r) rows.push({y:2025,m,row:r}); }
    return rows;
  }
  // andre år: kun historikk
  const enh=hist.byAreaYear[area]||{}; const rows=[];
  for(let m=1;m<=12;m++){ const r=enh[y]?.[m]; if(r) rows.push({y,m,row:r}); }
  return rows;
}

function computeMerged(area, period, hist, fut, monthlyKWt, useMode, energyMode){
  const fixedEx=NORGESPRIS_EX_ORE/100, cap=useMode==='fritid'?CAP_FRITID:CAP_BOLIG;
  const ms=monthsForPeriodMerged(area,period,hist,fut);
  const labels=[], kwhArr=[], priceS=[], priceNo=[], priceN=[], costS=[], costN=[], table=[];
  for(const {y,m,row} of ms){
    const k=monthlyKWt[m-1]||0;
    const priceEffIncl=calcMonthlySupportedIncl(row, energyMode);
    const priceNoIncl=(Number.isFinite(row.spot_ex)?row.spot_ex:row.eff_ex)*(1+VAT);
    const covered=Math.min(k,cap), excess=Math.max(0,k-cap);
    const spotExEx=Number.isFinite(row.spot_ex)?row.spot_ex:row.eff_ex;
    const priceNorgIncl = k>0 ? ((covered*fixedEx + excess*spotExEx)*(1+VAT)/k) : fixedIncl();
    const comparePriceIncl=(useMode==='fritid')?priceNoIncl:priceEffIncl;

    const cS=k*comparePriceIncl, cN=k*priceNorgIncl;

    labels.push(`${y}-${String(m).padStart(2,'0')}`);
    kwhArr.push(k); priceS.push(priceEffIncl); priceNo.push(priceNoIncl); priceN.push(priceNorgIncl);
    costS.push(cS); costN.push(cN);
    table.push({ month:`${MONTHS[m-1]} ${y}`, kwh:k, pS:priceEffIncl, pNo:priceNoIncl, pN:priceNorgIncl, cS, cN, d:cS-cN });
  }
  const sums={ kwh:kwhArr.reduce((a,b)=>a+b,0), cS:costS.reduce((a,b)=>a+b,0), cN:costN.reduce((a,b)=>a+b,0) };
  sums.d=sums.cS-sums.cN;
  return { labels,kwhArr,priceS,priceNo,priceN,costS,costN,table,sums };
}
</script>

<script>
let hist=null, fut=null;
let period='last12', useMode='bolig', energyMode='strom', shapePct=0, seasonMode='helars';

const areaEl=document.getElementById('area'); const annualEl=document.getElementById('annual');
const useChips=document.getElementById('useChips'); const insulChips=document.getElementById('insulChips'); const periodChips=document.getElementById('periodChips'); const energyChips=document.getElementById('energyChips');
const statusEl=document.getElementById('status'); const histTitleEl=document.getElementById('histTitle'); const forecastNote=document.getElementById('forecastNote');
const sumNEl=document.getElementById('sumN'), sumSEl=document.getElementById('sumS'), saveOutEl=document.getElementById('saveOut'), besparelseTextEl=document.getElementById('besparelseText');
const spotSummaryLabel=document.getElementById('spotSummaryLabel'); const fritidNote=document.getElementById('fritidNote');
const tblBody=document.querySelector('#tbl tbody'); const thPS=document.getElementById('thPS'); const thPNo=document.getElementById('thPNo'); const thCostSEl=document.getElementById('thCostS');

function setAreas(areas){
  areaEl.innerHTML=''; areas.forEach(a=>{ const o=document.createElement('option'); o.value=a; o.textContent=( {NO1:"NO1 - Østlandet",NO2:"NO2 - Sørlandet",NO3:"NO3 - Midt-Norge",NO4:"NO4 - Nord-Norge",NO5:"NO5 - Vestlandet"}[a] || a ); areaEl.appendChild(o); });
  areaEl.value=areas.includes('NO1')?'NO1':(areas[0]||'');
  updateAreaHeaders(); updateHistTitle();
}
function updateAreaHeaders(){ const a=areaEl.value||'NO?'; thPS.textContent=`${a} - spotpris med strømstøtte (kr/kWt)`; thPNo.textContent=`${a} - spotpris (kr/kWt)`; }
function updateHistTitle(){ const a=areaEl.value||'NO?'; histTitleEl.textContent=`Historiske + prognosepriser ${a}`; }

function setUseChips(){ useChips.innerHTML=''; [{val:'bolig',label:'Bolig'},{val:'fritid',label:'Fritidsbolig'}].forEach(p=>{const b=document.createElement('button'); b.className='chip'; b.textContent=p.label; b.dataset.val=p.val; b.onclick=()=>{useMode=p.val; updateUseChips(); recalc();}; useChips.appendChild(b);}); updateUseChips(); }
function updateUseChips(){[...useChips.querySelectorAll('.chip')].forEach(x=>x.classList.toggle('active',x.dataset.val===useMode));}
function setInsulChips(){ insulChips.innerHTML=''; [{label:'Dårlig',val:+30},{label:'Normal',val:0},{label:'God',val:-25}].forEach(p=>{const b=document.createElement('button'); b.className='chip'; b.textContent=p.label; b.dataset.val=p.val; b.onclick=()=>{shapePct=p.val; highlightInsul(p.val); recalc();}; insulChips.appendChild(b);}); highlightInsul(0); }
function highlightInsul(v){[...insulChips.querySelectorAll('.chip')].forEach(x=>x.classList.toggle('active',Number(x.dataset.val)===Number(v)));}

function setEnergyChips(){ energyChips.innerHTML=''; [{val:'strom',label:'Strøm'},{val:'fjernvarme',label:'Fjernvarme/Nærvarme'}].forEach(p=>{const b=document.createElement('button'); b.className='chip'; b.textContent=p.label; b.dataset.val=p.val; b.onclick=()=>{energyMode=p.val; updateEnergyChips(); recalc();}; energyChips.appendChild(b);}); updateEnergyChips(); }
function updateEnergyChips(){[...energyChips.querySelectorAll('.chip')].forEach(x=>x.classList.toggle('active',x.dataset.val===energyMode));}

function setPeriodChips(years){
  periodChips.innerHTML='';
  const mk=(val,label)=>{const b=document.createElement('button'); b.className='chip'; b.textContent=label; b.dataset.val=val; b.onclick=()=>{period=val; updatePeriodActive(); recalc();}; periodChips.appendChild(b);};
  mk('last12','Siste 12 mnd'); years.slice().reverse().forEach(y=>mk(String(y), String(y)));
  mk('2026p','2026 (Prognoser)');
  updatePeriodActive();
}
function updatePeriodActive(){[...periodChips.querySelectorAll('.chip')].forEach(x=>x.classList.toggle('active', x.dataset.val===String(period)));}

function getMonthlyArray(){ const annual=Number(annualEl.value||0); return annualToMonthly(annual,shapePct,useMode,'helars'); }

function renderTable(rows,sums){
  const body=tblBody; body.innerHTML='';
  for(const r of rows){
    const cls=r.d>0?'pos':(r.d<0?'neg':''); const sign=r.d<0?'-':'';
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.month}</td><td>${Math.round(r.kwh).toLocaleString('nb-NO')}</td>
      <td>${r.pNo.toFixed(2)}</td><td>${r.pS.toFixed(2)}</td><td>${r.pN.toFixed(2)}</td>
      <td>${kroner(r.cS)}</td><td>${kroner(r.cN)}</td><td class="${cls}">${sign}${kroner(Math.abs(r.d))}</td>`;
    body.appendChild(tr);
  }
  sumKwhEl.textContent=Math.round(sums.kwh).toLocaleString('nb-NO');
  sumCostSEl.textContent=kroner(sums.cS); sumCostNEl.textContent=kroner(sums.cN);
  sumDeltaEl.textContent=(sums.d<0?'-':'')+kroner(Math.abs(sums.d)); sumDeltaEl.className=sums.d>0?'pos':(sums.d<0?'neg':'');
  sumSEl.textContent=kroner(sums.cS); sumNEl.textContent=kroner(sums.cN);
  saveOutEl.textContent=(sums.d<0?'-':'')+kroner(Math.abs(sums.d)); saveOutEl.className=sums.d>0?'pos':(sums.d<0?'neg':'');
  besparelseTextEl.textContent=(sums.d>=0)?`Estimert besparelse: ${kroner(sums.d)}.`:`Estimert tap: ${kroner(-sums.d)}.`;
}

function renderBar(labels,kwh,cS,cN){
  const ctx=document.getElementById('barChart').getContext('2d');
  if(window.barChart) window.barChart.destroy();
  window.barChart=new Chart(ctx,{data:{labels, datasets:[
    {type:'bar',label:'Forbruk (kWt)',data:kwh,yAxisID:'yKwh',backgroundColor:'rgba(107,114,128,.35)',borderColor:'#6b7280',borderWidth:1,categoryPercentage:0.6,barPercentage:0.6,order:0},
    {type:'bar',label:'Kostnad spot',data:cS,yAxisID:'yKr',backgroundColor:'rgba(37,99,235,.45)',borderColor:'#2563eb',borderWidth:1,categoryPercentage:0.7,barPercentage:0.7,order:1},
    {type:'bar',label:'Kostnad norgespris',data:cN,yAxisID:'yKr',backgroundColor:'rgba(22,163,74,.45)',borderColor:'#16a34a',borderWidth:1,categoryPercentage:0.7,barPercentage:0.7,order:1}
  ]}, options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{position:'top'}},scales:{yKwh:{position:'left',title:{display:true,text:'kWt'},beginAtZero:true,grid:{drawOnChartArea:false}},yKr:{position:'right',title:{display:true,text:'Kr (inkl. mva)'},beginAtZero:true}}});
}

function renderPriceAll(area){
  const ctx=document.getElementById('priceChart').getContext('2d');
  if(window.priceChart) window.priceChart.destroy();

  // bygg lang serie: historikk først, deretter futures
  const seq=[];
  const H=hist.byAreaYear[area]||{}, F=fut.byAreaYear[area]||{};
  const hy=Object.keys(H).map(Number).sort((a,b)=>a-b); const fy=Object.keys(F).map(Number).sort((a,b)=>a-b);
  hy.forEach(y=>{ for(let m=1;m<=12;m++){ const r=H[y]?.[m]; if(r) seq.push({y,m,row:r}); }});
  fy.forEach(y=>{ for(let m=1;m<=12;m++){ const r=F[y]?.[m]; if(r) seq.push({y,m,row:r}); }});

  const labels=seq.map(o=>`${o.y}-${String(o.m).padStart(2,'0')}`);
  const pS=seq.map(o=>calcMonthlySupportedIncl(o.row, energyMode));
  const pNo=seq.map(o=>(Number.isFinite(o.row.spot_ex)?o.row.spot_ex:o.row.eff_ex)*(1+VAT));
  // norgespris effektiv: bruk valgte månedlige kWt for månedsindex
  const monthly=getMonthlyArray(); const cap=useMode==='fritid'?CAP_FRITID:CAP_BOLIG;
  const pN=seq.map(o=>{ const k=monthly[o.m-1]||0; const covered=Math.min(k,cap), excess=Math.max(0,k-cap);
    const spotExEx=Number.isFinite(o.row.spot_ex)?o.row.spot_ex:o.row.eff_ex; return k>0?((covered*(NORGESPRIS_EX_ORE/100)+excess*spotExEx)*(1+VAT)/k):fixedIncl(); });

  window.priceChart=new Chart(ctx,{ type:'line', data:{labels, datasets:[
    {label:`${area} spot u/støtte`, data:pNo, borderColor:'#9ca3af', backgroundColor:'rgba(156,163,175,.15)', tension:.15, pointRadius:0, borderWidth:2},
    {label:`${area} spot m/støtte`, data:pS, borderColor:'#2563eb', backgroundColor:'rgba(37,99,235,.15)', tension:.15, pointRadius:0, borderWidth:2},
    {label:'norgespris (effektiv)', data:pN, borderColor:'#16a34a', backgroundColor:'rgba(22,163,74,.15)', tension:.15, pointRadius:0, borderWidth:2}
  ]}, options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{y:{title:{display:true,text:'kr/kWt inkl. mva'},beginAtZero:true}}});
}

function recalc(){
  if(!hist||!fut) return;
  const area=areaEl.value; const monthly=getMonthlyArray();

  // map periodeverdi '2026p' -> 2026
  const effPeriod = (period==='2026p') ? 2026 : period;

  const {labels,kwhArr,priceS,priceNo,priceN,costS,costN,table,sums} = computeMerged(area, effPeriod, hist, fut, monthly, useMode, energyMode);
  renderBar(labels,kwhArr,costS,costN); renderTable(table,sums); renderPriceAll(area);

  // labels/tekst
  const isFritid = (useMode==='fritid');
  spotSummaryLabel.textContent = isFritid ? 'spot uten strømstøtte' : (energyMode==='fjernvarme' ? 'spot m/strømstøtte (måned)' : 'spot m/strømstøtte');
  thCostSEl.textContent = `Kostnad - ${isFritid ? 'spotpris uten strømstøtte' : (energyMode==='fjernvarme' ? 'spotpris m/strømstøtte (måned)' : 'spotpris med strømstøtte')} (kr)`;
  fritidNote.style.display=isFritid?'block':'none';
  histTitleEl.textContent=`Historiske + prognosepriser ${area}`;
  document.getElementById('status').textContent=`Viser ${labels.length} mnd for ${area}.`;

  // vis prognosefotnote dersom periode inkluderer futures (2025 med sep–des, eller 2026)
  const showNote = (effPeriod===2026) || (effPeriod===2025 && labels.some(x=>x.startsWith('2025-09')));
  document.getElementById('forecastNote').style.display = showNote ? 'block' : 'none';
  if(showNote){
    document.getElementById('forecastNote').textContent =
      'Prognosene er ingen garanti for fremtidig strømpris, men er et estimat basert på markedspris for fremtidskontrakter på strømbørsen NASDAQ. '+
      'Prognosene for fremtidige strømpriser er hentet fra https://bedrift.fortum.no/prognose-strompriser. Disse finnes kun per måned. '+
      'For å korrigere for enkelttimer over terskel for strømstøtte, er prisene fratrukket 5 %, som er gjennomsnittlig avvik mellom spotpris med strømstøtte beregnet per måned og per time.';
  }
}

(async function init(){
  try{
    hist = await loadCSV('data/monthly_avgs_v1.csv');
    fut  = await loadCSV('data/monthly_futures_v1.csv'); // NB: ingen -5% justering i kode
    const commonAreas = hist.areas.filter(a=>fut.areas.includes(a));
    setAreas(commonAreas.length?commonAreas:hist.areas);
    setUseChips(); setInsulChips(); setEnergyChips();
    const years = hist.years; // historikkår
    setPeriodChips(years);
    areaEl.addEventListener('change', recalc);
    annualEl.addEventListener('input', ()=>recalc());
    recalc();
  }catch(e){ console.error(e); document.getElementById('status').textContent='Feil ved lasting av data.'; }
})();
</script>
</body>
</html>
<!doctype html>
<html lang="nb">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Norgespris – Steg 4 (komplett)</title>
<style>
  :root{ --bg:#f7f7f8; --fg:#111; --muted:#6b7280; --card:#fff; --border:#e5e7eb }
  *{ box-sizing:border-box } html,body{ margin:0; background:var(--bg); color:var(--fg); font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial }
  .wrap{ max-width:1200px; margin:0 auto; padding:16px } .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px }
  .grid{ display:grid; gap:12px } .g3{ grid-template-columns:repeat(3,minmax(0,1fr)) } @media (max-width:1000px){ .g3{ grid-template-columns:1fr } }
  h1{ font-size:24px; margin:0 0 8px } p{ color:var(--muted); margin:0 0 12px }
  label{ display:block; font-size:13px; color:var(--muted); margin-bottom:6px }
  input[type="number"], select, button{ font:inherit } input[type="number"], select{ width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:#fff }
  .chips{ display:flex; gap:8px; flex-wrap:wrap } .chip{ padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; cursor:pointer } .chip.active{ background:#111; color:#fff; border-color:#111 }
  .muted{ color:#6b7280 } .big{ font-size:20px; font-weight:700 } .kv{ font-variant-numeric: tabular-nums }
  table{ width:100%; border-collapse:collapse; font-variant-numeric:tabular-nums } th,td{ padding:8px 10px; border-bottom:1px solid var(--border); text-align:right } th:first-child, td:first-child{ text-align:left }
  .note{ background:#fffaf0; border:1px solid #fde68a; color:#92400e; padding:10px 12px; border-radius:12px } .hr{ height:1px; background:var(--border); margin:8px 0 }
  .pos{ color:#16a34a } .neg{ color:#dc2626 }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
</head>
<body>
<div class="wrap">
  <h1>Norgespris</h1>
  <p>Historikk + prognoser. 2025: historikk t.o.m. aug, prognoser sep–des. Zoom i pris-grafen eller hopp til et år.</p>

  <div class="card grid g3">
    <div>
      <label for="area">Prisområde</label>
      <select id="area"></select>
      <small class="muted">NO6 er utelatt.</small>
    </div>
    <div>
      <label for="annual">Årlig forbruk (kWt)</label>
      <input id="annual" type="number" value="20000" min="0" step="100">
    </div>
    <div>
      <label>Boligtype</label>
      <div id="useChips" class="chips"></div>
      <small class="muted">Bolig tak 5000 kWt/mnd · Fritidsbolig tak 1000 kWt/mnd</small>
    </div>
    <div>
      <label>Isoleringsgrad</label>
      <div id="insulChips" class="chips"></div>
    </div>
    <div>
      <label>Periode</label>
      <div id="periodChips" class="chips"></div>
      <small class="muted">Siste 12 mnd, år – eller 2026 (Prognoser)</small>
    </div>
    <div>
      <label>Energibærer</label>
      <div id="energyChips" class="chips"></div>
      <small class="muted">Strøm: støtte timeskorrigert (fra CSV). Fjernvarme: støtte beregnet månedlig fra spot.</small>
    </div>
  </div>

  <div class="card grid g3" style="margin-top:12px">
    <div>
      <div class="big kv"><b>Estimert strømkostnad</b></div>
      <div class="muted">inkludert mva.</div>
    </div>
    <div>
      <div class="muted">norgespris</div>
      <div class="big kv" id="sumN">–</div>
      <div class="muted" style="margin-top:6px"><b>Besparelse norgespris:</b> <b id="saveOut">–</b></div>
      <div class="muted" id="besparelseText" style="margin-top:6px"></div>
    </div>
    <div>
      <div class="muted"><span id="spotSummaryLabel">spot m/strømstøtte</span></div>
      <div class="big kv" id="sumS">–</div>
      <div id="fritidNote" class="muted" style="margin-top:6px; display:none">Fritidsbolig får ikke strømstøtte.</div>
    </div>
  </div>

  <div class="note" style="margin-top:10px"><b>Viktig:</b> Ekskludert nettleie, avgifter og påslag.</div>

  <div class="card" style="margin-top:12px">
    <div class="row" style="display:flex;justify-content:space-between;align-items:center">
      <div class="muted">Forbruk og kostnader per måned</div>
      <div id="status" class="muted">Laster data …</div>
    </div>
    <div class="hr"></div>
    <div style="height:360px"><canvas id="barChart"></canvas></div>
  </div>

  <div class="card" style="margin-top:12px">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
      <div id="histTitle" class="muted">Historiske + prognosepriser</div>
      <div class="chips" id="yearJump"></div>
      <div><button id="resetZoom" class="chip">Nullstill zoom</button></div>
    </div>
    <div class="hr"></div>
    <div style="height:300px"><canvas id="priceChart"></canvas></div>
    <div id="forecastNote" class="muted" style="margin-top:8px; display:none; font-size:13px"></div>
  </div>
</div>

<script>
// === Konstanter og helpers ===
const VAT=0.25, NORGESPRIS_EX_ORE=40, CAP_BOLIG=5000, CAP_FRITID=1000;
const MONTHS=["Jan","Feb","Mar","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Des"];
const AREA_LABELS={ NO1:"NO1 - Østlandet", NO2:"NO2 - Sørlandet", NO3:"NO3 - Midt-Norge", NO4:"NO4 - Nord-Norge", NO5:"NO5 - Vestlandet" };
const BASE_WINTER=[13.5,12,10,8.5,7,5.5,4.5,5,7,8.5,10,12]; const SUMMER_MONTHS=new Set([4,5,6,7,8,9]);
const normalizeProfile=p=>{const s=p.reduce((a,b)=>a+b,0)||1; return p.map(x=>x*100/s);};
function shapedProfile(shape){const b=normalizeProfile(BASE_WINTER),u=100/12; return b.map(p=>u+(p-u)*(1+shape));}
function applySeasonMode(p,mode){const mult=p.map((_,i)=>{const m=i+1,s=SUMMER_MONTHS.has(m); if(mode==='sommer')return s?1:0.2; if(mode==='vinter')return s?0.1:1; return 1;}); const adj=p.map((v,i)=>v*mult[i]); const S=adj.reduce((a,b)=>a+b,0)||1; return adj.map(x=>x*100/S);}
function annualToMonthly(annual,shapePct,useMode,seasonMode){let prof=shapedProfile(shapePct/100); if(useMode==='fritid') prof=applySeasonMode(prof,seasonMode); return prof.map(p=>(annual||0)*(p/100));}
const kroner=n=>(n||0).toLocaleString("nb-NO",{style:"currency",currency:"NOK",maximumFractionDigits:0});
const fixedIncl=()=> (NORGESPRIS_EX_ORE/100)*(1+VAT);

async function loadCSV(path){
  const r=await fetch(path,{cache:'no-store'}); if(!r.ok) throw new Error('Kunne ikke hente '+path);
  let txt=(await r.text()).replace(/^\uFEFF/,'').replace(/\r\n?/g,'\n').trim();
  const first=txt.split('\n',1)[0], seps=[',',';','\t','|'];
  const sep=seps.reduce((b,s)=>{const c=(first.match(new RegExp('\\'+s,'g'))||[]).length; return c>b.c?{s,c}:b;},{s:',',c:0}).s;
  const [head,...lines]=txt.split('\n').filter(l=>l.trim()); const headers=head.split(sep).map(h=>h.toLowerCase().trim());
  const idx=Object.fromEntries(headers.map((h,i)=>[h,i])); const hasSpot='avg_spot_nok_ex' in idx;
  const sample=(lines[0]||'').split(sep).map(s=>s.trim());
  const usesComma=[idx['avg_effective_nok_ex'],hasSpot?idx['avg_spot_nok_ex']:-1].map(i=>i>=0?sample[i]||'':'').some(v=> /,\d{1,3}$/.test(v)||(v.includes(',')&&!v.includes('.')));
  const toNum=s=>{let t=String(s??'').trim().replace(/\u00A0/g,'').replace(/\s/g,''); if(usesComma){t=t.replace(/\./g,'').replace(',','.');} return Number(t);};
  const rows=[]; for(const line of lines){
    const c=line.split(sep); const area=(c[idx.area]||'').trim().toUpperCase(); if(area==='NO6') continue;
    const y=toNum(c[idx.year]), m=toNum(c[idx.month]); const eff_ex=toNum(c[idx['avg_effective_nok_ex']]); const spot_ex=hasSpot?toNum(c[idx['avg_spot_nok_ex']]):NaN;
    if(!area||!Number.isFinite(y)||!Number.isFinite(m)) continue; rows.push({area,year:y,month:m,eff_ex,spot_ex});
  }
  const byAreaYear={}, areas=new Set(), years=new Set();
  for(const r2 of rows){ areas.add(r2.area); years.add(r2.year); byAreaYear[r2.area]??={}; byAreaYear[r2.area][r2.year]??={}; byAreaYear[r2.area][r2.year][r2.month]=r2; }
  return { byAreaYear, areas:[...areas].sort(), years:[...years].sort((a,b)=>a-b) };
}

function calcMonthlySupportedIncl(row, energyMode){
  const spotIncl=(Number.isFinite(row.spot_ex)?row.spot_ex:row.eff_ex)*(1+VAT);
  if(energyMode==='strom'){ return row.eff_ex*(1+VAT); }
  const over=Math.max(0, spotIncl - 0.94);
  return spotIncl - 0.90*over;
}

// Periodevalg med merge (2025 hybrid, 2026 prognose)
function monthsForPeriodMerged(area, period, hist, fut){
  const out=[];
  if(period==='last12'){
    const allHist=[]; const ent=hist.byAreaYear[area]||{};
    Object.keys(ent).map(Number).sort((a,b)=>a-b).forEach(y=>{ for(let m=1;m<=12;m++){ const r=ent[y]?.[m]; if(r) allHist.push({y,m,row:r}); } });
    if(allHist.length>=12) return allHist.slice(-12);
    const allFut=[]; const enf=fut.byAreaYear[area]||{};
    Object.keys(enf).map(Number).sort((a,b)=>a-b).forEach(y=>{ for(let m=1;m<=12;m++){ const r=enf[y]?.[m]; if(r) allFut.push({y,m,row:r}); } });
    return [...allHist, ...allFut].slice(-12);
  }
  const y=Number(period);
  if(y===2026){
    const enf=fut.byAreaYear[area]||{}; const rows=[]; for(let m=1;m<=12;m++){ const r=enf[2026]?.[m]; if(r) rows.push({y:2026,m,row:r}); } return rows;
  }
  if(y===2025){
    const enh=hist.byAreaYear[area]||{}, enf=fut.byAreaYear[area]||{}, rows=[];
    for(let m=1;m<=8;m++){ const r=enh[2025]?.[m]; if(r) rows.push({y:2025,m,row:r}); }
    for(let m=9;m<=12;m++){ const r=enf[2025]?.[m]; if(r) rows.push({y:2025,m,row:r}); }
    return rows;
  }
  const enh=hist.byAreaYear[area]||{}; const rows=[]; for(let m=1;m<=12;m++){ const r=enh[y]?.[m]; if(r) rows.push({y,m,row:r}); } return rows;
}

function computeMerged(area, period, hist, fut, monthlyKWt, useMode, energyMode){
  const fixedEx=NORGESPRIS_EX_ORE/100, cap=useMode==='fritid'?CAP_FRITID:CAP_BOLIG;
  const ms=monthsForPeriodMerged(area,period,hist,fut);
  const labels=[], kwhArr=[], priceS=[], priceNo=[], priceN=[], costS=[], costN=[], table=[];
  for(const {y,m,row} of ms){
    const k=monthlyKWt[m-1]||0;
    const priceEffIncl=calcMonthlySupportedIncl(row, energyMode);
    const priceNoIncl=(Number.isFinite(row.spot_ex)?row.spot_ex:row.eff_ex)*(1+VAT);
    const covered=Math.min(k,cap), excess=Math.max(0,k-cap);
    const spotExEx=Number.isFinite(row.spot_ex)?row.spot_ex:row.eff_ex;
    const priceNorgIncl=k>0?((covered*fixedEx + excess*spotExEx)*(1+VAT)/k):fixedIncl();
    const comparePriceIncl=(useMode==='fritid')?priceNoIncl:priceEffIncl;
    const cS=k*comparePriceIncl, cN=k*priceNorgIncl;
    labels.push(`${y}-${String(m).padStart(2,'0')}`); kwhArr.push(k);
    priceS.push(priceEffIncl); priceNo.push(priceNoIncl); priceN.push(priceNorgIncl);
    costS.push(cS); costN.push(cN);
    table.push({month:`${MONTHS[m-1]} ${y}`,kwh:k,pS:priceEffIncl,pNo:priceNoIncl,pN:priceNorgIncl,cS,cN,d:cS-cN});
  }
  const sums={kwh:kwhArr.reduce((a,b)=>a+b,0), cS:costS.reduce((a,b)=>a+b,0), cN:costN.reduce((a,b)=>a+b,0)}; sums.d=sums.cS-sums.cN;
  return {labels,kwhArr,priceS,priceNo,priceN,costS,costN,table,sums};
}
</script>

<script>
let hist=null, fut=null;
let period='last12', useMode='bolig', energyMode='strom', shapePct=0, seasonMode='helars';

const areaEl=document.getElementById('area'), annualEl=document.getElementById('annual');
const useChips=document.getElementById('useChips'), insulChips=document.getElementById('insulChips'), periodChips=document.getElementById('periodChips'), energyChips=document.getElementById('energyChips');
const statusEl=document.getElementById('status'), histTitleEl=document.getElementById('histTitle'), forecastNote=document.getElementById('forecastNote');
const sumNEl=document.getElementById('sumN'), sumSEl=document.getElementById('sumS'), saveOutEl=document.getElementById('saveOut'), besparelseTextEl=document.getElementById('besparelseText');
const spotSummaryLabel=document.getElementById('spotSummaryLabel'), fritidNote=document.getElementById('fritidNote');
const tblBody=document.querySelector('#tbl tbody'); const thPS=document.getElementById('thPS'); const thPNo=document.getElementById('thPNo'); const thCostSEl=document.getElementById('thCostS');
const yearJump=document.getElementById('yearJump'); const resetZoomBtn=document.getElementById('resetZoom');

function setAreas(areas){
  areaEl.innerHTML=''; areas.forEach(a=>{ const o=document.createElement('option'); o.value=a; o.textContent=(AREA_LABELS[a]||a); areaEl.appendChild(o); });
  areaEl.value=areas.includes('NO1')?'NO1':(areas[0]||''); updateAreaHeaders(); updateHistTitle();
}
function updateAreaHeaders(){ const a=areaEl.value||'NO?'; thPS.textContent=`${a} - spotpris med strømstøtte (kr/kWt)`; thPNo.textContent=`${a} - spotpris (kr/kWt)`; }
function updateHistTitle(){ const a=areaEl.value||'NO?'; histTitleEl.textContent=`Historiske + prognosepriser ${a}`; }

function setUseChips(){ useChips.innerHTML=''; [{val:'bolig',label:'Bolig'},{val:'fritid',label:'Fritidsbolig'}].forEach(p=>{const b=document.createElement('button'); b.className='chip'; b.textContent=p.label; b.dataset.val=p.val; b.onclick=()=>{useMode=p.val; updateUseChips(); recalc();}; useChips.appendChild(b);}); updateUseChips(); }
function updateUseChips(){[...useChips.querySelectorAll('.chip')].forEach(x=>x.classList.toggle('active',x.dataset.val===useMode));}
function setInsulChips(){ insulChips.innerHTML=''; [{label:'Dårlig',val:+30},{label:'Normal',val:0},{label:'God',val:-25}].forEach(p=>{const b=document.createElement('button'); b.className='chip'; b.textContent=p.label; b.dataset.val=p.val; b.onclick=()=>{shapePct=p.val; highlightInsul(p.val); recalc();}; insulChips.appendChild(b);}); highlightInsul(0); }
function highlightInsul(v){[...insulChips.querySelectorAll('.chip')].forEach(x=>x.classList.toggle('active',Number(x.dataset.val)===Number(v)));}

function setEnergyChips(){ energyChips.innerHTML=''; [{val:'strom',label:'Strøm'},{val:'fjernvarme',label:'Fjernvarme/Nærvarme'}].forEach(p=>{const b=document.createElement('button'); b.className='chip'; b.textContent=p.label; b.dataset.val=p.val; b.onclick=()=>{energyMode=p.val; updateEnergyChips(); recalc();}; energyChips.appendChild(b);}); updateEnergyChips(); }
function updateEnergyChips(){[...energyChips.querySelectorAll('.chip')].forEach(x=>x.classList.toggle('active',x.dataset.val===energyMode));}

function setPeriodChips(years){
  periodChips.innerHTML='';
  const mk=(val,label)=>{const b=document.createElement('button'); b.className='chip'; b.textContent=label; b.dataset.val=val; b.onclick=()=>{period=val; updatePeriodActive(); recalc();}; periodChips.appendChild(b);};
  mk('last12','Siste 12 mnd'); years.slice().reverse().forEach(y=>mk(String(y), String(y))); mk('2026p','2026 (Prognoser)');
  updatePeriodActive();
}
function updatePeriodActive(){[...periodChips.querySelectorAll('.chip')].forEach(x=>x.classList.toggle('active', x.dataset.val===String(period)));}

function getMonthlyArray(){ const annual=Number(annualEl.value||0); return annualToMonthly(annual,shapePct,useMode,'helars'); }

function renderTable(rows,sums){
  const body=tblBody; body.innerHTML='';
  for(const r of rows){
    const cls=r.d>0?'pos':(r.d<0?'neg':''); const sign=r.d<0?'-':'';
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.month}</td><td>${Math.round(r.kwh).toLocaleString('nb-NO')}</td>
      <td>${r.pNo.toFixed(2)}</td><td>${r.pS.toFixed(2)}</td><td>${r.pN.toFixed(2)}</td>
      <td>${kroner(r.cS)}</td><td>${kroner(r.cN)}</td><td class="${cls}">${sign}${kroner(Math.abs(r.d))}</td>`;
    body.appendChild(tr);
  }
  document.getElementById('sumKwh').textContent=Math.round(sums.kwh).toLocaleString('nb-NO');
  document.getElementById('sumCostS').textContent=kroner(sums.cS); document.getElementById('sumCostN').textContent=kroner(sums.cN);
  const deltaEl=document.getElementById('sumDelta'); deltaEl.textContent=(sums.d<0?'-':'')+kroner(Math.abs(sums.d)); deltaEl.className=sums.d>0?'pos':(sums.d<0?'neg':'');
  sumSEl.textContent=kroner(sums.cS); sumNEl.textContent=kroner(sums.cN);
  saveOutEl.textContent=(sums.d<0?'-':'')+kroner(Math.abs(sums.d)); saveOutEl.className=sums.d>0?'pos':(sums.d<0?'neg':'');
  besparelseTextEl.textContent=(sums.d>=0)?`Estimert besparelse: ${kroner(sums.d)}.`:`Estimert tap: ${kroner(-sums.d)}.`;
}

function renderBar(labels,kwh,cS,cN){
  const ctx=document.getElementById('barChart').getContext('2d');
  if(window.barChart) window.barChart.destroy();
  window.barChart=new Chart(ctx,{data:{labels, datasets:[
    {type:'bar',label:'Forbruk (kWt)',data:kwh,yAxisID:'yKwh',backgroundColor:'rgba(107,114,128,.35)',borderColor:'#6b7280',borderWidth:1,categoryPercentage:0.6,barPercentage:0.6,order:0},
    {type:'bar',label:'Kostnad spot',data:cS,yAxisID:'yKr',backgroundColor:'rgba(37,99,235,.45)',borderColor:'#2563eb',borderWidth:1,categoryPercentage:0.7,barPercentage:0.7,order:1},
    {type:'bar',label:'Kostnad norgespris',data:cN,yAxisID:'yKr',backgroundColor:'rgba(22,163,74,.45)',borderColor:'#16a34a',borderWidth:1,categoryPercentage:0.7,barPercentage:0.7,order:1}
  ]}, options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{position:'top'}},scales:{yKwh:{position:'left',title:{display:true,text:'kWt'},beginAtZero:true,grid:{drawOnChartArea:false}},yKr:{position:'right',title:{display:true,text:'Kr (inkl. mva)'},beginAtZero:true}}});
}

let priceLabels=[], priceSeriesS=[], priceSeriesNo=[], priceSeriesN=[];
function buildPriceSeries(area){
  priceLabels=[]; priceSeriesS=[]; priceSeriesNo=[]; priceSeriesN=[];
  const H=hist.byAreaYear[area]||{}, F=fut.byAreaYear[area]||{};
  const hy=Object.keys(H).map(Number).sort((a,b)=>a-b); const fy=Object.keys(F).map(Number).sort((a,b)=>a-b);
  const seq=[];
  hy.forEach(y=>{ for(let m=1;m<=12;m++){ const r=H[y]?.[m]; if(r) seq.push({y,m,row:r}); }});
  fy.forEach(y=>{ for(let m=1;m<=12;m++){ const r=F[y]?.[m]; if(r) seq.push({y,m,row:r}); }});
  const monthly=getMonthlyArray(); const cap=useMode==='fritid'?CAP_FRITID:CAP_BOLIG;
  for(const o of seq){
    priceLabels.push(`${o.y}-${String(o.m).padStart(2,'0')}`);
    priceSeriesS.push( calcMonthlySupportedIncl(o.row, energyMode) );
    priceSeriesNo.push( (Number.isFinite(o.row.spot_ex)?o.row.spot_ex:o.row.eff_ex)*(1+VAT) );
    const k=monthly[o.m-1]||0; const covered=Math.min(k,cap), excess=Math.max(0,k-cap); const spotExEx=Number.isFinite(o.row.spot_ex)?o.row.spot_ex:o.row.eff_ex;
    priceSeriesN.push( k>0?((covered*(NORGESPRIS_EX_ORE/100)+excess*spotExEx)*(1+VAT)/k):fixedIncl() );
  }
}

function renderPrice(){
  const ctx=document.getElementById('priceChart').getContext('2d');
  if(window.priceChart) window.priceChart.destroy();
  window.priceChart=new Chart(ctx,{ type:'line', data:{labels:priceLabels, datasets:[
    {label:`Spot u/støtte`, data:priceSeriesNo, borderColor:'#9ca3af', backgroundColor:'rgba(156,163,175,.15)', tension:.15, pointRadius:0, borderWidth:2},
    {label:`Spot m/støtte`, data:priceSeriesS, borderColor:'#2563eb', backgroundColor:'rgba(37,99,235,.15)', tension:.15, pointRadius:0, borderWidth:2},
    {label:'Norgespris (eff.)', data:priceSeriesN, borderColor:'#16a34a', backgroundColor:'rgba(22,163,74,.15)', tension:.15, pointRadius:0, borderWidth:2}
  ]}, options:{
    responsive:true, maintainAspectRatio:false,
    plugins:{
      legend:{position:'top'},
      zoom:{
        pan:{enabled:true, mode:'x'},
        zoom:{wheel:{enabled:true}, pinch:{enabled:true}, mode:'x'}
      }
    },
    scales:{ y:{title:{display:true,text:'kr/kWt inkl. mva'}, beginAtZero:true } }
  }});
}

function buildYearJumpButtons(){
  yearJump.innerHTML='';
  const years=[...new Set(priceLabels.map(l=>Number(l.slice(0,4))))];
  years.forEach(Y=>{
    const b=document.createElement('button'); b.className='chip'; b.textContent=String(Y);
    b.onclick=()=>{
      // finn første og siste index for året Y
      const firstIdx=priceLabels.findIndex(l=>l.startsWith(String(Y)+'-'));
      const lastIdx=[...priceLabels].reverse().findIndex(l=>l.startsWith(String(Y)+'-'));
      const endIdx = lastIdx<0?firstIdx:(priceLabels.length-1-lastIdx);
      if(firstIdx>=0 && endIdx>=firstIdx){
        const chart=window.priceChart;
        chart.resetZoom();
        chart.scales.x.options.min=firstIdx-0.5;
        chart.scales.x.options.max=endIdx+0.5;
        chart.update();
      }
    };
    yearJump.appendChild(b);
  });
  resetZoomBtn.onclick=()=>{ if(window.priceChart){ window.priceChart.resetZoom(); window.priceChart.update(); } };
}

function recalc(){
  if(!hist||!fut) return;
  const area=areaEl.value; const monthly=annualToMonthly(Number(annualEl.value||0),shapePct,useMode,'helars');
  const effectivePeriod = (period==='2026p')?2026:period;

  const {labels,kwhArr,priceS,priceNo,priceN,costS,costN,table,sums} = computeMerged(area,effectivePeriod,hist,fut,monthly,useMode,energyMode);
  renderBar(labels,kwhArr,costS,costN); renderTable(table,sums);

  const isFritid=(useMode==='fritid');
  spotSummaryLabel.textContent=isFritid?'spot uten strømstøtte':(energyMode==='fjernvarme'?'spot m/strømstøtte (måned)':'spot m/strømstøtte');
  thCostSEl.textContent=`Kostnad - ${isFritid?'spotpris uten strømstøtte':(energyMode==='fjernvarme'?'spotpris m/strømstøtte (måned)':'spotpris med strømstøtte')} (kr)`;
  fritidNote.style.display=isFritid?'block':'none';

  // Pris-graf full serie (hist + futures), zoombar
  buildPriceSeries(area); renderPrice(); buildYearJumpButtons();

  // Fotnote om prognoser
  const showNote=(effectivePeriod===2026) || (effectivePeriod===2025 && labels.some(x=>x.startsWith('2025-09')));
  forecastNote.style.display=showNote?'block':'none';
  if(showNote){
    forecastNote.textContent='Prognosene er ingen garanti for fremtidig strømpris, men er et estimat basert på markedspris for fremtidskontrakter på strømbørsen NASDAQ. Prognosene for fremtidige strømpriser er hentet fra https://bedrift.fortum.no/prognose-strompriser. Disse finnes kun per måned. For å korrigere for enkelttimer over terskel for strømstøtte, er prisene fratrukket 5 %, som er gjennomsnittlig avvik mellom spotpris med strømstøtte beregnet per måned og per time.';
  }

  statusEl.textContent=`Viser ${labels.length} mnd for ${area}.`;
}

(async function init(){
  try{
    hist = await loadCSV('data/monthly_avgs_v1.csv');
    fut  = await loadCSV('data/monthly_futures_v1.csv'); // NB: ingen -5% i kode
    const commonAreas = hist.areas.filter(a=>fut.areas.includes(a));
    setAreas(commonAreas.length?commonAreas:hist.areas);

    setUseChips(); setInsulChips(); setEnergyChips();

    const years=hist.years;
    // legg til 2025 (hybrid) om det finnes i hist eller fut, og 2026 prognoser-knapp
    setPeriodChips(years);
    areaEl.addEventListener('change', recalc);
    annualEl.addEventListener('input', ()=>recalc());
    recalc();
  }catch(e){ console.error(e); statusEl.textContent='Feil ved lasting av data.'; }
})();
</script>
</body>
</html>
