<!doctype html>
<html lang="nb">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Norgespris</title>
  <meta name="description" content="Sammenlign norgespris med spotpris og strømstøtte.">
  <style>
    :root{ --bg:#f7f7f8; --fg:#111; --muted:#6b7280; --card:#fff; --border:#e5e7eb; }
    *{ box-sizing:border-box }
    html,body{ margin:0; background:var(--bg); color:var(--fg); font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial }
    .wrap{ max-width:1200px; margin:0 auto; padding:16px }
    h1{ font-size:24px; margin:0 0 6px }
    p{ margin:0 0 12px; color:var(--muted) }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; }
    .grid{ display:grid; gap:12px }
    .g3{ grid-template-columns:repeat(3,minmax(0,1fr)) }
    @media (max-width:1000px){ .g3{ grid-template-columns:1fr } }
    label{ display:block; font-size:13px; color:var(--muted); margin-bottom:6px }
    input[type="number"], select, button{ font:inherit }
    input[type="number"], select{ width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:#fff }
    button{ padding:8px 12px; border-radius:10px; border:1px solid var(--border); background:#fff; cursor:pointer }
    .row{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
    .muted{ color:var(--muted) }
    .big{ font-size:20px; font-weight:700 }
    .kv{ font-variant-numeric: tabular-nums }
    .chips{ display:flex; gap:8px; flex-wrap:wrap }
    .chip{ padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; cursor:pointer }
    .chip.active{ background:#111; color:#fff; border-color:#111 }
    .note{ background:#fffaf0; border:1px solid #fde68a; color:#92400e; padding:10px 12px; border-radius:12px }
    .disabled{ opacity:.5; pointer-events:none }
    .pos{ color:#16a34a } .neg{ color:#dc2626 }
    table{ width:100%; border-collapse:collapse; font-variant-numeric:tabular-nums }
    th,td{ padding:8px 10px; border-bottom:1px solid var(--border); text-align:right }
    th:first-child, td:first-child{ text-align:left }
    tfoot td{ font-weight:700 }
    .hr{ height:1px; background:var(--border); margin:8px 0 }
    details.info { margin:8px 0 0 }
    details.info > summary { cursor:pointer; padding:8px 12px; border:1px solid var(--border); border-radius:10px; background:#fff; display:inline-block }
    details.info[open] > summary { background:#111; color:#fff; border-color:#111 }
    .info-box { margin-top:10px; border:1px solid var(--border); border-radius:12px; background:#fff; padding:12px }
    .footnote { margin-top:8px; font-size:12px; color:#6b7280 }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2"></script>
</head>
<body>
<div class="wrap">
  <h1>Norgespris</h1>
  <p>Legg inn årlig forbruk eller egne månedstall. Vi bruker historiske energipriser og prognoser for valgt prisområde og sammenligner norgespris med spotpris og strømstøtte. Alle beløp vises inkl. mva.</p>

  <!-- Info-knapp/boks -->
  <details class="info">
    <summary>info om norgespris</summary>
    <div class="info-box">
      <p><b>Hva er norgespris:</b><br>
      norgespris er en statlig ordning som gir deg mulighet til å betale en fast strømpris på 0,5 kr/kWt (inkl. mva), i stedet for dagens ordning med variabel «spotpris» per time og strømstøtte.
      norgespris kan bestilles digitalt via <a href="https://minside.elhub.no" target="_blank" rel="noopener">https://minside.elhub.no</a> med BankID. Her kan du også finne ditt historiske forbruk, til mer nøyaktig beregning av kostnader med/uten norgespris i verktøyet under.</p>
      <p>Ordningen gjelder fra og med 1. oktober 2025 til og med 31. desember 2026. Bindingstid er ut 31. desember 2026. Etter bestilling har man 14 dagers angrefrist.</p>
      <p>norgespris vil også gjelde for fritidsboliger, som ikke får strømstøtte med dagens ordning. norgespris har et forbrukstak på 5000 kWt/mnd for boliger, og 1000 kWt/mnd for fritidsbolig. Forbruk over dette belastes med vanlig spotpris uten strømstøtte.</p>
      <p><b>Hva er alternativet:</b><br>
      Alle privatboliger i Norge mottar automatisk strømstøtte. Denne ordningen gir 90 % støtte for strømpris over 0,94 kr/kWt (inkl. mva). Dvs. hvis strømprisen i en time er 1,04 kr/kWt får du i strømstøtte: (1,04−0,94)*0,9 = 0,09 kr/kWt, og du betaler kun 0,93 kr/kWt. De som ikke aktivt velger norgespris, fortsetter på denne ordningen.</p>
      <p><b>Lønner det seg å velge norgespris:</b><br>
      Det kommer an på fremtidige strømpriser i ditt prisområde, og er derfor umulig å si. Den beste indikasjonen er å vurdere dette ut ifra ditt forbruk og historiske strømpriser. I beregningsverktøyet under kan du legge inn årlig strømforbruk og få en sammenligning av kostnadene med og uten norgespris, basert på tidligere strømpriser i ditt område.</p>
    </div>
  </details>

  <!-- Inndata -->
  <div class="card grid g3" style="margin-top:12px">
    <div>
      <label for="area">Prisområde</label>
      <select id="area"></select>
      <small class="muted">NO1 er standard hvis tilgjengelig.</small>
    </div>

    <div id="annualBox">
      <label for="annual">Årlig forbruk (kWt)</label>
      <input id="annual" type="number" value="20000" min="0" step="100">
      <small class="muted">Bruk helår. Fordeles på måneder etter profil (eller summen av manuelle måneder).</small>
    </div>

    <div id="useBox">
      <label>Boligtype</label>
      <div id="useChips" class="chips"></div>
      <small class="muted"><b>Bolig</b>: tak 5000 kWt/mnd. <b>Fritidsbolig</b>: tak 1000 kWt/mnd.</small>
      <div id="seasonWrap" style="margin-top:8px; display:none">
        <label style="margin:0 0 6px">Bruk av fritidsbolig</label>
        <div class="chips">
          <button class="chip" data-season="helars">helårs</button>
          <button class="chip" data-season="sommer">sommerhalvår</button>
          <button class="chip" data-season="vinter">vinterhalvår</button>
        </div>
      </div>
    </div>

    <div id="insulBox">
      <label>Isoleringsgrad</label>
      <div id="insulChips" class="chips"></div>
    </div>

    <div>
      <label>Velg periode energipriser i beregning</label>
      <div id="periodChips" class="chips"></div>
      <small class="muted">“Siste 12 mnd”, et bestemt år eller 2026 (Prognoser).</small>
    </div>

    <div>
      <label>Energibærer</label>
      <div id="energyChips" class="chips"></div>
      <small class="muted">Fjernvarme/nærvarme bruker støtte beregnet fra <i>månedssnitt</i> (ikke timeverdier).</small>
    </div>

    <div>
      <label>Manuell månedsutfylling</label>
      <div class="row">
        <button id="manualToggle" class="chip">Fyll inn forbruk per måned selv</button>
        <button id="manualShowHide">Skjul felter</button>
      </div>
      <small class="muted">Når aktivt: Årlig forbruk blir sum av månedsfeltene (read-only). Uutfylte måneder = 0.</small>
    </div>
  </div>

  <!-- Manuelle månedsfelter (over grafen) -->
  <div id="manualCard" class="card" style="margin-top:12px; display:none">
    <div class="row" style="justify-content:space-between">
      <div class="muted">Fyll inn kWt per måned (oppdateres umiddelbart)</div>
      <div class="row">
        <button id="fillProfile">Fyll med estimert profil</button>
        <button id="clearAll">Tøm alle</button>
      </div>
    </div>
    <div class="hr"></div>
    <div id="customInputs" class="grid g3" style="margin-bottom:8px"></div>
    <div class="muted">Sum manuelle måneder: <b><span id="manualSum">0</span> kWt</b> (vises som årlig forbruk i denne modusen)</div>
  </div>

  <!-- Oppsummering -->
  <div class="card grid g3" style="margin-top:12px">
    <div>
      <div class="big kv"><b>Estimert strømkostnad</b></div>
      <div class="muted">inkludert mva.</div>
    </div>
    <div>
      <div class="muted">norgespris</div>
      <div class="big kv" id="sumN">–</div>
      <div class="muted" style="margin-top:6px"><b>Besparelse norgespris:</b> <b id="saveOut">–</b></div>
      <div class="muted" id="besparelseText" style="margin-top:6px"></div>
    </div>
    <div>
      <div class="muted"><span id="spotSummaryLabel">spot m/strømstøtte</span></div>
      <div class="big kv" id="sumS">–</div>
      <div id="fritidNote" class="muted" style="margin-top:6px; display:none">Fritidsbolig får ikke strømstøtte.</div>
    </div>
  </div>

  <!-- Gul infoboks under oppsummering -->
  <div class="note" style="margin-top:10px">
    <b>Viktig:</b> Ekskludert nettleie, avgifter og påslag. Disse påvirkes ikke av norgespris.
  </div>

  <!-- Hovedgraf: kWt = tynn grå stolpe, kostnader = tykkere stolper -->
  <div class="card" style="margin-top:12px">
    <div class="row" style="justify-content:space-between">
      <div class="muted">Forbruk (grå diskret stolpe) og kostnader (stolper) for valgt periode</div>
      <div id="status" class="muted">Laster data …</div>
    </div>
    <div class="hr"></div>
    <div style="height:360px"><canvas id="barChart"></canvas></div>
  </div>

  <!-- Tabell -->
  <div class="card" style="margin-top:12px">
    <div style="overflow:auto">
      <table id="tbl">
        <thead>
          <tr>
            <th>Måned</th>
            <th>kWt</th>
            <th id="thPNo">NO? - spotpris (kr/kWt)</th>
            <th id="thPS">NO? - spotpris med strømstøtte (kr/kWt)</th>
            <th>norgespris - effektiv (kr/kWt)</th>
            <th id="thCostS">Kostnad - spotpris med strømstøtte (kr)</th>
            <th>Kostnad - norgespris (kr)</th>
            <th>Besparelse med norgespris (kr)</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td>SUM</td>
            <td id="sumKwh">–</td>
            <td></td><td></td><td></td>
            <td id="sumCostS">–</td>
            <td id="sumCostN">–</td>
            <td id="sumDelta">–</td>
          </tr>
        </tfoot>
      </table>
      <small class="muted">* “norgespris - effektiv (kr/kWt)” er gjennomsnittsprisen når evt. forbruk over forbrukstaket prises med spot uten strømstøtte.</small>
    </div>
  </div>

  <!-- Historiske priser + zoom + fotnote -->
  <div class="card" style="margin-top:12px">
    <div class="row" style="justify-content:space-between; align-items:center">
      <div>
        <div id="histTitle" class="muted">Historiske energipriser</div>
        <div id="forecastNote" class="footnote" style="display:none"></div>
      </div>
      <div class="row">
        <button id="resetZoomBtn">Nullstill zoom</button>
      </div>
    </div>
    <div class="hr"></div>
    <div style="height:300px"><canvas id="priceChart"></canvas></div>
  </div>
</div>

<script>
  // ---- Konstanter & hjelpere ----
  const VAT = 0.25;
  const NORGESPRIS_EX_ORE = 40;                 // eks. mva (øre/kWt)
  const CAP_BOLIG = 5000;                       // kWt/mnd (fastpris-tak)
  const CAP_FRITID = 1000;                      // kWt/mnd (fastpris-tak)
  const MONTHS = ["Jan","Feb","Mar","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Des"];
  const FUTURE_START = { y: 2025, m: 9 };       // Prognoser gjelder fra og med sep 2025

  const AREA_LABELS = {
    NO1: "NO1 - Østlandet",
    NO2: "NO2 - Sørlandet",
    NO3: "NO3 - Midt-Norge",
    NO4: "NO4 - Nord-Norge",
    NO5: "NO5 - Vestlandet",
    NO6: "NO6 - Nord-øst"
  };

  // Basisprofil (vintertung) brukes både for bolig og fritidsbolig
  const BASE_WINTER = [13.5,12,10,8.5,7,5.5,4.5,5,7,8.5,10,12];

  // Sommerhalvår = Apr–Sep (4–9)
  const SUMMER_MONTHS = new Set([4,5,6,7,8,9]);

  const normalizeProfile = p => { const s = p.reduce((a,b)=>a+b,0)||1; return p.map(x => x * 100 / s); };

  // Isoleringsgrad (chips) → prosent (−25, 0, +30)
  let shapePct = 0; // i prosent

  function shapedProfile(shape){
    const base = normalizeProfile(BASE_WINTER);
    const uniform = 100/12;
    // shape ∈ [-0.5,+0.5]: -0.5 → flatere, +0.5 → mer vintertyngde
    return base.map(p => uniform + (p - uniform) * (1 + shape));
  }

  // seasonMode: 'helars' | 'sommer' | 'vinter'
  function applySeasonMode(profile, seasonMode){
    const mult = profile.map((_,i)=>{
      const m = i+1;
      const isSummer = SUMMER_MONTHS.has(m);
      if(seasonMode==='sommer'){
        return isSummer ? 1 : 0.2; // vinter = grunnvarme
      } else if(seasonMode==='vinter'){
        return isSummer ? 0.1 : 1; // sommer ≈ nær null
      }
      return 1; // helårs
    });
    const adj = profile.map((p,i)=>p*mult[i]);
    const s = adj.reduce((a,b)=>a+b,0)||1;
    return adj.map(x=>x*100/s);
  }

  function annualToMonthly(annual, shape, useMode, seasonMode){
    let prof = shapedProfile(shape);
    if (useMode === 'fritid') {
      prof = applySeasonMode(prof, seasonMode);
    }
    const baseAnnual = Math.max(0, Number(annual)||0);
    return prof.map(pct => baseAnnual * (pct/100));
  }

  const kroner = n => (n||0).toLocaleString("nb-NO",{ style:"currency", currency:"NOK", maximumFractionDigits:0 });
  const fixedIncl = () => (NORGESPRIS_EX_ORE/100) * (1+VAT);
  const q = (arr,p=0.95) => { const a = arr.filter(Number.isFinite).slice().sort((x,y)=>x-y); if(!a.length) return 1; const i = Math.floor((a.length-1)*p); return a[i]; };

  // ---- Robust CSV: BOM + separator + desimal-komma ----
  async function loadCsvGeneric(path){
    const res = await fetch(path, { cache: 'no-store' });
    if(!res.ok) throw new Error('Kunne ikke hente '+path);

    let txt = await res.text();
    txt = txt.replace(/^\\uFEFF/, '').replace(/\\r\\n?/g, '\\n').trim();
    if (!txt) throw new Error('CSV er tom: '+path);

    const firstLine = txt.split('\\n', 1)[0];
    const seps = [',',';','\\t','|'];
    const sep = seps.reduce((best, s) => {
      const count = (firstLine.match(new RegExp(`\\\\${s}`,'g'))||[]).length;
      return count > best.count ? { s, count } : best;
    }, { s: ',', count: 0 }).s;

    const [head, ...lines] = txt.split('\\n').filter(l => l.trim().length);
    const headers = head.split(sep).map(h => h.replace(/^\\uFEFF/,'').trim().toLowerCase());
    const idx = Object.fromEntries(headers.map((h,i)=>[h,i]));

    const required = ['area','year','month','avg_effective_nok_ex'];
    const missing = required.filter(k => !(k in idx));
    if (missing.length) throw new Error('Mangler kolonner i '+path+': ' + missing.join(', '));

    const hasSpot = 'avg_spot_nok_ex' in idx;

    // Desimal-komma?
    const sampleCols = (lines[0] || '').split(sep).map(s=>s.trim());
    const probe = [idx['avg_effective_nok_ex'], hasSpot ? idx['avg_spot_nok_ex'] : -1]
                    .map(i => i>=0 ? sampleCols[i] || '' : '');
    const usesCommaDecimal = probe.some(v => /,\\d{1,3}$/.test(v) || (v.includes(',') && !v.includes('.')));

    const toNum = (s) => {
      if (s == null) return NaN;
      let t = String(s).trim().replace(/\\u00A0/g,'').replace(/\\s/g,'');
      if (usesCommaDecimal) t = t.replace(/\\./g,'').replace(',', '.');
      return Number(t);
    };

    const rows = [];
    for (const line of lines) {
      const cols = line.split(sep);
      if (cols.length < headers.length) continue;
      const area = (cols[idx.area] || '').trim().toUpperCase();
      const year = toNum(cols[idx.year]);
      const month = toNum(cols[idx.month]);
      const eff_ex = toNum(cols[idx['avg_effective_nok_ex']]); // NOK/kWt eks mva (m/støtte)
      const spot_ex = hasSpot ? toNum(cols[idx['avg_spot_nok_ex']]) : NaN; // NOK/kWt eks mva (u/støtte)
      if (!area || !Number.isFinite(year) || !Number.isFinite(month)) continue;
      rows.push({ area, year, month, eff_ex, spot_ex });
    }

    const byAreaYear = {};
    const areas = new Set();
    const years = new Set();
    for (const r of rows) {
      areas.add(r.area);
      years.add(r.year);
      byAreaYear[r.area] ??= {};
      byAreaYear[r.area][r.year] ??= {};
      byAreaYear[r.area][r.year][r.month] = r;
    }

    return {
      byAreaYear,
      years: [...years].sort((a,b)=>a-b),
      areas: [...areas].sort()
    };
  }

  async function loadAll(){
    const hist = await loadCsvGeneric('data/monthly_avgs_v1.csv');
    const fut  = await loadCsvGeneric('data/monthly_futures_v1.csv');

    // Merge områder
    const areas = Array.from(new Set([...(hist.areas||[]), ...(fut.areas||[])])).sort();
    // År-liste for valg (hist-år + 2025 + 2026 prognose)
    const yearSet = new Set([...(hist.years||[]) , 2025]);
    const years = Array.from(yearSet).sort();

    return { hist, fut, areas, years };
  }

  // ---- Periodevalg -> liste av måneder ----
  // period: 'last12' | 'YYYY' | '2026p'
  function monthsInPeriod(data, area, period){
    const H = data.hist.byAreaYear[area]||{};
    const F = data.fut.byAreaYear[area]||{};
    const listAll = [];
    const years = Array.from(new Set([...Object.keys(H).map(Number), ...Object.keys(F).map(Number)])).sort((a,b)=>a-b);
    for(const y of years){
      for(let m=1;m<=12;m++){
        const rowH = H[y]?.[m];
        const rowF = F[y]?.[m];
        const hasAny = !!(rowH || rowF);
        if (hasAny) listAll.push({y,m,rowH,rowF});
      }
    }

    if(period === 'last12'){
      // Kun historikk siste 12
      const histList = listAll.filter(x=>x.rowH).slice(-12);
      return histList.map(x=>({y:x.y,m:x.m,row: x.rowH, source:'hist'}));
    }

    if(period === '2026p'){
      // Prognoser for hele 2026
      const y=2026; const out=[];
      for(let m=1;m<=12;m++){ const r = F[y]?.[m]; if(r) out.push({y, m, row:r, source:'fut'}); }
      return out;
    }

    // Et konkret år
    const y = Number(period);
    const out = [];
    for(let m=1;m<=12;m++){
      let row = H[y]?.[m] || null; let source='hist';
      if (y===FUTURE_START.y && m>=FUTURE_START.m && F[y]?.[m]){ // sep–des 2025 fra prognoser
        row = F[y][m]; source='fut';
      }
      if (row) out.push({y,m,row,source});
    }
    return out;
  }

  // ---- Støtteberegning for fjernvarme (månedssnitt) ----
  function monthlySupportAdjustedIncl(spotMonthlyEx){
    const pIncl = spotMonthlyEx * (1+VAT);
    const thresh = 0.94; // kr/kWt inkl mva
    if (pIncl <= thresh) return pIncl; // ingen støtte
    const support = (pIncl - thresh) * 0.90; // 90 % over terskel
    return pIncl - support;
  }

  // ---- Beregning ----
  function compute(area, period, data, monthlyKWt, useMode, energyMode){
    const fixedEx = NORGESPRIS_EX_ORE/100;              // eks mva
    const cap = useMode === 'fritid' ? CAP_FRITID : CAP_BOLIG;
    const ms = monthsInPeriod(data, area, period);

    const labels = [], kwhArr = [], priceS = [], priceNo = [], priceN = [],
          costS = [], costN = [], table = [];

    for(const {y,m,row,source} of ms){
      const k = monthlyKWt[m-1] || 0;

      // For prognoser bruker vi månedspriser. For strøm reduseres 5 % for å etterligne timesbasert støtte.
      const spotExEx = Number.isFinite(row.spot_ex) ? row.spot_ex : row.eff_ex; // fallback

      // spot uten støtte (inkl mva)
      const priceNoIncl = spotExEx * (1+VAT);

      // spot med støtte (inkl mva)
      let priceEffIncl;
      if (useMode === 'fritid'){
        // fritidsbolig: ingen støtte
        priceEffIncl = priceNoIncl;
      } else if (energyMode === 'fjernvarme'){
        // fjernvarme: støtte beregnes direkte fra månedssnittet
        priceEffIncl = monthlySupportAdjustedIncl(spotExEx);
      } else {
        // strøm
        if (source==='fut'){
          priceEffIncl = (spotExEx * 0.95) * (1+VAT); // -5 % justering
        } else {
          priceEffIncl = row.eff_ex * (1+VAT); // historisk effektive fra fil
        }
      }

      // norgespris: inntil cap til fastpris, overskytende til spot u/støtte
      const covered = Math.min(k, cap);
      const excess  = Math.max(0, k - cap);
      const priceNorgIncl = (k>0)
        ? ((covered*fixedEx + excess*spotExEx)*(1+VAT) / k)
        : fixedIncl();

      // Sammenligningsgrunnlag: fritidsbolig → spot uten støtte, ellers spot m/støtte
      const comparePriceIncl = (useMode === 'fritid') ? priceNoIncl : priceEffIncl;

      const cS = k * comparePriceIncl;
      const cN = k * priceNorgIncl;

      labels.push(`${y}-${String(m).padStart(2,'0')}`);
      kwhArr.push(k);
      priceS.push(priceEffIncl);
      priceNo.push(priceNoIncl);
      priceN.push(priceNorgIncl);
      costS.push(cS);
      costN.push(cN);

      table.push({
        month: `${MONTHS[m-1]} ${y}`,
        kwh: k, pS: priceEffIncl, pNo: priceNoIncl, pN: priceNorgIncl, cS, cN, d: cS - cN
      });
    }

    const sums = {
      kwh: kwhArr.reduce((a,b)=>a+b,0),
      cS: costS.reduce((a,b)=>a+b,0),
      cN: costN.reduce((a,b)=>a+b,0),
      d:  costS.reduce((a,b)=>a+b,0) - costN.reduce((a,b)=>a+b,0)
    };
    return { labels, kwhArr, priceS, priceNo, priceN, costS, costN, table, sums };
  }

  // ---- UI refs ----
  const areaEl = document.getElementById('area');
  const annualEl = document.getElementById('annual');
  const insulChips = document.getElementById('insulChips');
  const useChips = document.getElementById('useChips');
  const energyChips = document.getElementById('energyChips');
  const periodChips = document.getElementById('periodChips');

  const seasonWrap = document.getElementById('seasonWrap');
  let seasonMode = 'helars'; // 'helars' | 'sommer' | 'vinter'

  const manualCard = document.getElementById('manualCard');
  const manualToggle = document.getElementById('manualToggle');
  const manualShowHide = document.getElementById('manualShowHide');
  const manualInputsBox = document.getElementById('customInputs');
  const manualSumEl = document.getElementById('manualSum');
  const btnFillProfile = document.getElementById('fillProfile');
  const btnClearAll = document.getElementById('clearAll');

  const sumNEl = document.getElementById('sumN');
  const sumSEl = document.getElementById('sumS');
  const saveOutEl = document.getElementById('saveOut');
  const besparelseTextEl = document.getElementById('besparelseText');
  const statusEl = document.getElementById('status');
  const histTitleEl = document.getElementById('histTitle');
  const forecastNoteEl = document.getElementById('forecastNote');
  const resetZoomBtn = document.getElementById('resetZoomBtn');

  const tblBody = document.querySelector('#tbl tbody');
  const thPS = document.getElementById('thPS');
  const thPNo = document.getElementById('thPNo');
  const thCostSEl = document.getElementById('thCostS');
  const sumKwhEl = document.getElementById('sumKwh');
  const sumCostSEl = document.getElementById('sumCostS');
  const sumCostNEl = document.getElementById('sumCostN');
  const sumDeltaEl = document.getElementById('sumDelta');

  const annualBox = document.getElementById('annualBox');
  const insulBox  = document.getElementById('insulBox');
  const useBox    = document.getElementById('useBox');

  const spotSummaryLabel = document.getElementById('spotSummaryLabel');
  const fritidNote = document.getElementById('fritidNote');

  let dataAll, barChart, priceChart, period = 'last12', useMode = 'bolig'; // 'bolig' | 'fritid'
  let energyMode = 'strom'; // 'strom' | 'fjernvarme'
  let manualMode = false;
  let manualVisible = true;
  let manualValues = Array(12).fill(null); // null = ikke satt => 0 i kalkyle

  function setAreas(areas){
    areaEl.innerHTML = "";
    for(const a of areas){
      const opt = document.createElement('option');
      opt.value = a;
      opt.textContent = AREA_LABELS[a] || a;
      areaEl.appendChild(opt);
    }
    areaEl.value = areas.includes('NO1') ? 'NO1' : (areas[0] || '');
    updateAreaHeaders();
    updateHistTitle();
  }
  function updateAreaHeaders(){
    const a = areaEl.value || 'NO?';
    thPS.textContent  = `${a} - spotpris med strømstøtte (kr/kWt)`;
    thPNo.textContent = `${a} - spotpris (kr/kWt)`;
  }
  function updateHistTitle(){
    const a = areaEl.value || 'NO?';
    histTitleEl.textContent = `Historiske energipriser ${a}`;
  }

  function setPeriodChips(years){
    periodChips.innerHTML = "";
    const mk = (val, label) => {
      const b = document.createElement('button');
      b.className = 'chip'; b.textContent = label; b.dataset.val = val;
      b.onclick = () => { period = val; updateActiveChips(); recalc(); };
      periodChips.appendChild(b);
    };
    mk('last12', 'Siste 12 mnd');
    years.slice().reverse().forEach(y => mk(String(y), String(y)));
    mk('2026p', '2026 (Prognoser)');
    updateActiveChips();
  }
  function updateActiveChips(){
    [...periodChips.querySelectorAll('.chip')].forEach(x=>x.classList.toggle('active', x.dataset.val===String(period)));
  }

  function setInsulChips(){
    insulChips.innerHTML = "";
    const presets = [
      { label:'Dårlig', val:+30 },
      { label:'Normal', val: 0  },
      { label:'God',    val:-25 },
    ];
    presets.forEach(p=>{
      const b = document.createElement('button');
      b.className = 'chip'; b.textContent = p.label; b.dataset.val = p.val;
      b.onclick = () => { shapePct = p.val; highlightInsul(p.val); if(!manualMode) recalc(); };
      insulChips.appendChild(b);
    });
    highlightInsul(0);
  }
  function highlightInsul(percent){
    [...insulChips.querySelectorAll('.chip')].forEach(x=>x.classList.toggle('active', Number(x.dataset.val)===Number(percent)));
  }

  function setUseChips(){
    useChips.innerHTML = "";
    [
      { val:'bolig',  label:'Bolig' },
      { val:'fritid', label:'Fritidsbolig' }
    ].forEach(p=>{
      const b = document.createElement('button');
      b.className = 'chip'; b.textContent = p.label; b.dataset.val = p.val;
      b.onclick = () => {
        useMode = p.val;
        updateUseChips();
        seasonWrap.style.display = (useMode==='fritid') ? 'block' : 'none';
        if (useMode!=='fritid') seasonMode = 'helars';
        recalc();
      };
      useChips.appendChild(b);
    });
    updateUseChips();

    // sesong-knapper
    seasonWrap.querySelectorAll('[data-season]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        seasonMode = btn.dataset.season;
        seasonWrap.querySelectorAll('[data-season]').forEach(x=>x.classList.toggle('active', x===btn));
        recalc();
      });
    });
    seasonWrap.querySelector('[data-season="helars"]')?.classList.add('active');
  }
  function updateUseChips(){
    [...useChips.querySelectorAll('.chip')].forEach(x=>x.classList.toggle('active', x.dataset.val===useMode));
  }

  function setEnergyChips(){
    energyChips.innerHTML = "";
    [
      { val:'strom', label:'Strøm' },
      { val:'fjernvarme', label:'Fjernvarme/Nærvarme' }
    ].forEach(p=>{
      const b = document.createElement('button');
      b.className = 'chip'; b.textContent = p.label; b.dataset.val = p.val;
      b.onclick = () => { energyMode = p.val; updateEnergyChips(); recalc(); };
      energyChips.appendChild(b);
    });
    updateEnergyChips();
  }
  function updateEnergyChips(){
    [...energyChips.querySelectorAll('.chip')].forEach(x=>x.classList.toggle('active', x.dataset.val===energyMode));
  }

  // Manuelle inputs
  function buildManualInputs(){
    manualInputsBox.innerHTML = "";
    for(let i=0;i<12;i++){
      const wrap = document.createElement('div');
      const lab = document.createElement('label'); lab.textContent = MONTHS[i];
      const inp = document.createElement('input');
      inp.type = 'number'; inp.min = '0'; inp.step = '1';
      inp.value = manualValues[i]==null ? '' : String(manualValues[i]);
      inp.id = `m_${i}`;
      inp.addEventListener('input', () => {
        const raw = inp.value.trim();
        manualValues[i] = raw==='' ? null : Math.max(0, Number(raw));
        updateManualSum();
        recalc(); // live
      });
      wrap.appendChild(lab); wrap.appendChild(inp);
      manualInputsBox.appendChild(wrap);
    }
  }
  function updateManualInputsFromArray(arr){
    for(let i=0;i<12;i++){
      const el = document.getElementById(`m_${i}`);
      if (el) el.value = arr[i]==null ? '' : String(arr[i]);
    }
  }
  function updateManualSum(){
    const s = manualValues.reduce((a,v)=>a+(v==null?0:v),0);
    manualSumEl.textContent = Math.round(s).toLocaleString('nb-NO');
    if (manualMode) {
      annualEl.value = String(Math.round(s)); // Årsforbruk = sum manuell
    }
  }

  function setDisabledForManual(active){
    // Lås isolerings-chips i manuell modus; boligtype/sesongvalg forblir aktive
    insulBox.classList.toggle('disabled', active);
    [...insulChips.querySelectorAll('button')].forEach(b=>b.disabled = active);
    useBox.classList.remove('disabled');
    [...useChips.querySelectorAll('button')].forEach(b=>b.disabled = false);
    seasonWrap.querySelectorAll('button').forEach(b=>b.disabled = (useMode!=='fritid') ? true : false);
    // Årlig forbruk: les-kun i manuell modus (ikke grå)
    annualEl.readOnly = active;
  }

  function renderTable(rows, sums){
    tblBody.innerHTML = "";
    for(const r of rows){
      const cls = r.d>0 ? 'pos' : (r.d<0 ? 'neg' : '');
      const sign = r.d<0 ? '-' : '';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.month}</td>
        <td>${Math.round(r.kwh).toLocaleString('nb-NO')}</td>
        <td>${r.pNo.toFixed(2)}</td>
        <td>${r.pS.toFixed(2)}</td>
        <td>${r.pN.toFixed(2)}</td>
        <td>${kroner(r.cS)}</td>
        <td>${kroner(r.cN)}</td>
        <td class="${cls}">${sign}${kroner(Math.abs(r.d))}</td>`;
      tblBody.appendChild(tr);
    }
    sumKwhEl.textContent = Math.round(sums.kwh).toLocaleString('nb-NO');
    sumCostSEl.textContent = kroner(sums.cS);
    sumCostNEl.textContent = kroner(sums.cN);
    sumDeltaEl.textContent  = (sums.d<0 ? '-' : '') + kroner(Math.abs(sums.d));
    sumDeltaEl.className = sums.d>0 ? 'pos' : (sums.d<0 ? 'neg' : '');

    sumSEl.textContent = kroner(sums.cS);
    sumNEl.textContent = kroner(sums.cN);

    saveOutEl.textContent = (sums.d<0 ? '-' : '') + kroner(Math.abs(sums.d));
    saveOutEl.className = sums.d>0 ? 'pos' : (sums.d<0 ? 'neg' : '');
    if (sums.d >= 0) {
      besparelseTextEl.textContent = `Det er estimert at du sparer ${kroner(sums.d)} årlig med norgespris basert på dine valgte forutsetninger.`;
    } else {
      besparelseTextEl.textContent = `Det er estimert at du taper ${kroner(-sums.d)} årlig med norgespris basert på dine valgte forutsetninger.`;
    }
  }

  // Hovedgraf: kWt = tynn grå stolpe, kostnader = tykkere stolper
  function renderMixedChart(labels, kwh, costS, costN){
    const ctx = document.getElementById('barChart').getContext('2d');
    if(barChart) barChart.destroy();
    const ymaxKwh  = q(kwh,0.95)*1.25;
    const ymaxCost = Math.max(q(costS,0.95), q(costN,0.95))*1.15;

    const spotCostLabel = (useMode === 'fritid') ? 'Kostnad spot u/støtte' : (energyMode==='fjernvarme' ? 'Kostnad spot m/støtte (måned)' : 'Kostnad spot m/støtte');

    barChart = new Chart(ctx, {
      data: {
        labels,
        datasets: [
          { type:'bar', label:'Forbruk (kWt)', data:kwh, yAxisID:'yKwh',
            backgroundColor:'rgba(107,114,128,.35)', borderColor:'#6b7280', borderWidth:1,
            categoryPercentage:0.45, barPercentage:0.40, order:0 },
          { type:'bar', label: spotCostLabel, data:costS, yAxisID:'yKr',
            backgroundColor:'rgba(37, 99, 235, .45)', borderColor:'#2563eb', borderWidth:1,
            categoryPercentage:0.80, barPercentage:0.75, order:1 },
          { type:'bar', label:'Kostnad norgespris', data:costN, yAxisID:'yKr',
            backgroundColor:'rgba(22, 163, 74, .45)', borderColor:'#16a34a', borderWidth:1,
            categoryPercentage:0.80, barPercentage:0.75, order:1 },
        ]
      },
      options: {
        responsive:true, maintainAspectRatio:false,
        interaction:{ mode:'index', intersect:false },
        plugins:{ legend:{ display:true, position:'top' } },
        scales:{
          yKwh:{ position:'left', title:{display:true, text:'kWt'}, suggestedMax:ymaxKwh, beginAtZero:true, grid:{ drawOnChartArea:false }},
          yKr:{ position:'right', title:{display:true, text:'Kr (inkl. mva)'}, suggestedMax:ymaxCost, beginAtZero:true }
        }
      }
    });
  }

  function renderPriceChart(labels, priceS, priceN, priceNo, area, showForecastNote){
    const ctx = document.getElementById('priceChart').getContext('2d');
    if(priceChart) priceChart.destroy();
    const ymax = Math.max(q(priceS,0.95), q(priceN,0.95), q(priceNo,0.95)) * 1.15;
    priceChart = new Chart(ctx, {
      type:'line',
      data:{ labels, datasets:[
        { label:`${area} spot u/støtte (inkl. mva)`, data:priceNo, borderColor:'#9ca3af', backgroundColor:'rgba(156,163,175,.15)', tension:.15, pointRadius:0, borderWidth:2 },
        { label:`${area} spot m/støtte (inkl. mva)`, data:priceS,  borderColor:'#2563eb', backgroundColor:'rgba(37,99,235,.15)',  tension:.15, pointRadius:0, borderWidth:2 },
        { label:'norgespris (effektiv, inkl. mva)', data:priceN,    borderColor:'#16a34a', backgroundColor:'rgba(22,163,74,.15)',  tension:.15, pointRadius:0, borderWidth:2 }
      ]},
      options:{
        responsive:true, maintainAspectRatio:false,
        plugins:{ 
          legend:{ display:true, position:'top' },
          title:{ display:true, text:`Historiske energipriser ${area}` },
          zoom: {
            zoom: { wheel: { enabled:true }, pinch: { enabled:true }, mode:'x' },
            pan:  { enabled:true, mode:'x' }
          }
        },
        scales:{ y:{ title:{display:true,text:'kr/kWt (inkl. mva)'}, suggestedMax:ymax, beginAtZero:true } }
      }
    });

    // Fotnote ved bruk av prognoser
    if (showForecastNote){
      forecastNoteEl.style.display = 'block';
      forecastNoteEl.innerHTML = `Prognosene er ingen garanti for fremtidig strømpris, men er et estimat basert på markedspris for fremtidskontrakter på strømbørsen NASDAQ.<br>
      Prognosene for fremtidige strømpriser er hentet fra <a href="https://bedrift.fortum.no/prognose-strompriser" target="_blank" rel="noopener">https://bedrift.fortum.no/prognose-strompriser</a>.<br>
      Disse finnes kun per måned. For å korrigere for enkelttimer over terskel for strømstøtte, er prisene fratrukket 5 %, som er gjennomsnittlig avvik mellom spotpris med strømstøtte beregnet per måned og per time.`;
    } else {
      forecastNoteEl.style.display = 'none';
      forecastNoteEl.textContent = '';
    }
  }

  // ---- Recalc ----
  const deb = (fn, ms=300) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };

  function getMonthlyArray(){
    if (manualMode) {
      return manualValues.map(v => v==null ? 0 : v);
    } else {
      const annual = Number(annualEl.value||0);
      const shape  = shapePct / 100;
      return annualToMonthly(annual, shape, useMode, seasonMode);
    }
  }

  function updateSpotComparisonLabels(){
    const isFritid = (useMode === 'fritid');
    if (isFritid){
      spotSummaryLabel.textContent = 'spot uten strømstøtte';
      thCostSEl.textContent = 'Kostnad - spotpris uten strømstøtte (kr)';
      fritidNote.style.display = 'block';
    } else {
      const suffix = (energyMode==='fjernvarme') ? ' (måned)' : '';
      spotSummaryLabel.textContent = `spot m/strømstøtte${suffix}`;
      thCostSEl.textContent = `Kostnad - spotpris med strømstøtte${suffix} (kr)`;
      fritidNote.style.display = 'none';
    }
  }

  function recalc(){
    if(!dataAll) return;
    updateAreaHeaders();
    updateHistTitle();
    updateSpotComparisonLabels();

    const area = areaEl.value;
    const monthlyKWt = getMonthlyArray();
    if (manualMode) updateManualSum();

    const { labels, kwhArr, priceS, priceNo, priceN, costS, costN, table, sums } =
      compute(area, period, dataAll, monthlyKWt, useMode, energyMode);

    renderMixedChart(labels, kwhArr, costS, costN);
    renderTable(table, sums);

    statusEl.textContent = `Viser ${labels.length} måneder for ${area}.`;

    // Serie for prisgraf (hele tidslinjen, bland hist/fut der de finnes)
    const H = dataAll.hist.byAreaYear[area]||{};
    const F = dataAll.fut.byAreaYear[area]||{};
    const years = Array.from(new Set([...Object.keys(H).map(Number), ...Object.keys(F).map(Number)])).sort((a,b)=>a-b);
    const allList=[]; for(const y of years){ for(let m=1;m<=12;m++){ const rh=H[y]?.[m]; const rf=F[y]?.[m]; if(rh||rf){ const useFut = (y>FUTURE_START.y) || (y===FUTURE_START.y && m>=FUTURE_START.m && rf); const row = useFut?rf:rh; const source = useFut?'fut':'hist'; allList.push({y,m,row,source}); }}}

    const pLabels = allList.map(o=>`${o.y}-${String(o.m).padStart(2,'0')}`);
    const cap = useMode === 'fritid' ? CAP_FRITID : CAP_BOLIG;

    const pNo = allList.map(o => { const spotExEx = Number.isFinite(o.row.spot_ex)?o.row.spot_ex:o.row.eff_ex; return spotExEx*(1+VAT); });
    const pS = allList.map(o => {
      const spotExEx = Number.isFinite(o.row.spot_ex)?o.row.spot_ex:o.row.eff_ex;
      if (useMode==='fritid') return spotExEx*(1+VAT);
      if (energyMode==='fjernvarme') return monthlySupportAdjustedIncl(spotExEx);
      return (o.source==='fut' ? spotExEx*0.95 : o.row.eff_ex) * (1+VAT);
    });
    const pN = allList.map(o=>{
      const k = monthlyKWt[o.m-1]||0;
      const spotExEx = Number.isFinite(o.row.spot_ex)?o.row.spot_ex:o.row.eff_ex;
      const covered = Math.min(k, cap), excess = Math.max(0, k - cap);
      return (k>0) ? ((covered*(NORGESPRIS_EX_ORE/100)+excess*spotExEx)*(1+VAT)/k) : fixedIncl();
    });

    const usingForecast = allList.some(o=>o.source==='fut') && (period==='2025' || period==='2026p');
    renderPriceChart(pLabels, pS, pN, pNo, area, usingForecast);
  }

  // ---- Init ----
  (async function(){
    try{
      dataAll = await loadAll();

      setAreas(dataAll.areas);
      setPeriodChips(dataAll.years);
      setInsulChips();
      setUseChips();
      setEnergyChips();
      buildManualInputs();

      areaEl.addEventListener('change', recalc);
      annualEl.addEventListener('input', deb(()=>{ if(!manualMode) recalc(); }, 200));
      resetZoomBtn.addEventListener('click', ()=>{ if(priceChart) priceChart.resetZoom(); });
      document.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key==='0'){ e.preventDefault(); if(priceChart) priceChart.resetZoom(); }});

      manualToggle.addEventListener('click', ()=>{
        manualMode = !manualMode;
        setDisabledForManual(manualMode);
        manualCard.style.display = manualMode && manualVisible ? 'block' : (manualMode ? 'none' : 'none');
        if (manualMode) { buildManualInputs(); updateManualSum(); }
        manualToggle.classList.toggle('active', manualMode);
        manualToggle.textContent = manualMode ? 'Manuell utfylling aktiv' : 'Fyll inn forbruk per måned selv';
        recalc();
      });

      manualShowHide.addEventListener('click', ()=>{
        if (!manualMode) return;
        manualVisible = !manualVisible;
        manualCard.style.display = manualVisible ? 'block' : 'none';
      });

      btnFillProfile.addEventListener('click', ()=>{
        const annual = Number(annualEl.value||0);
        const shape  = shapePct / 100;
        const arr = annualToMonthly(annual, shape, useMode, seasonMode).map(x=>Math.round(x));
        manualValues = arr.slice();
        updateManualInputsFromArray(manualValues);
        updateManualSum();
        recalc();
      });

      btnClearAll.addEventListener('click', ()=>{
        manualValues = Array(12).fill(null);
        updateManualInputsFromArray(manualValues);
        updateManualSum();
        recalc();
      });

      recalc();
    }catch(e){
      console.error(e);
      statusEl.textContent = 'Feil ved lasting av data. Sjekk at data/monthly_avgs_v1.csv og data/monthly_futures_v1.csv er tilgjengelige.';
    }
  })();
</script>
</body>
</html>
